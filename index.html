<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatismes Math√©matiques</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        h1 {
            color: #764ba2;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: bold;
            color: #333;
        }

        select, input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .quiz-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 400px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .question-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .timer {
            font-size: 1.2em;
            color: #666;
            font-weight: bold;
        }

        .question-content {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .question-text {
            font-size: 1.3em;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .math-display {
            font-size: 1.4em;
            margin: 15px 0;
            text-align: center;
        }

        .answer-input {
            padding: 12px 20px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            max-width: 100%;
            transition: border-color 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .question-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-validate {
            background: #28a745;
        }

        .btn-validate:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-skip {
            background: #ffc107;
        }

        .btn-skip:hover {
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .explanation-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid;
        }

        .explanation-box.correct {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .explanation-box.incorrect {
            background: #ffebee;
            border-color: #f44336;
        }

        .math-steps {
            margin-top: 10px;
            line-height: 2.5;
        }

        .math-step {
            display: block;
            margin: 8px 0;
            font-size: 1.1em;
        }

        .figure-container {
            margin: 20px 0;
            text-align: center;
        }

        .figure-container svg {
            max-width: 100%;
            height: auto;
        }

        .results {
            text-align: center;
            padding: 40px;
        }

        .score {
            font-size: 3em;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        .results-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .results-details h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .question-review {
            text-align: left;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .question-review.correct {
            border-left: 4px solid #28a745;
        }

        .question-review.incorrect {
            border-left: 4px solid #dc3545;
        }

        .review-explanation {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 3px solid #9c27b0;
        }

        .time-info {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            color: #1976d2;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
                justify-content: space-between;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìê Automatismes Math√©matiques</h1>
            <div class="subtitle">Entra√Ænement aux calculs sans calculatrice mais avec un brouillon</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="questionCount">Nombre de questions:</label>
                <input type="number" id="questionCount" min="5" max="30" value="10">
            </div>
            <button onclick="startQuiz()">üöÄ Commencer le test</button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="welcome" id="welcome">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">Bienvenue !</h2>
                <p style="text-align: center; font-size: 1.1em; color: #666; line-height: 1.8;">
                    Ce g√©n√©rateur cr√©e automatiquement des questions d'automatismes math√©matiques vari√©es.<br>
                    Configurez vos pr√©f√©rences ci-dessus et cliquez sur "Commencer le test" pour d√©buter.<br><br>
                    Plus de 30 types de questions diff√©rents : calculs, fractions, pourcentages, g√©om√©trie, probabilit√©s, statistiques et plus encore !<br><br>
                    Un chronom√®tre suit votre temps par question pour vous aider √† am√©liorer votre rapidit√©.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentQuestionIndex = 0;
        let questions = [];
        let userAnswers = [];
        let timer = null;
        let timeElapsed = 0;
        let hasAnswered = false;
        let questionStartTime = 0;
        let questionTimes = [];

        // Fonction pour convertir en virgule d√©cimale
        function toFrenchNumber(num, decimals = null) {
            if (typeof num === 'number') {
                if (decimals !== null) {
                    num = num.toFixed(decimals);
                } else {
                    num = num.toString();
                }
            }
            return num.replace('.', ',');
        }

        // Fonction pour parser un nombre avec virgule
        function parseDecimal(str) {
            return parseFloat(
                str.replace(/\s|\u00A0|\u202F/g, '')
                   .replace(',', '.')
            );
        }

        // Fonction pour cr√©er des formules math√©matiques avec KaTeX
        function renderMath(latex) {
            const span = document.createElement('span');
            katex.render(latex, span, {
                throwOnError: false,
                displayMode: false
            });
            return span.outerHTML;
        }

        // Fonction pour cr√©er des formules math√©matiques en display
        function renderMathDisplay(latex) {
            const div = document.createElement('div');
            katex.render(latex, div, {
                throwOnError: false,
                displayMode: true
            });
            return div.outerHTML;
        }

        // Fonction pour cr√©er des explications multi-lignes
        function renderExplanation(steps) {
            let html = '<div class="math-steps">';
            steps.forEach(step => {
                html += '<div class="math-step">' + renderMath(step) + '</div>';
            });
            html += '</div>';
            return html;
        }

        // Fonction pour formater le temps
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) {
                return `${mins}min ${secs}s`;
            }
            return `${secs}s`;
        }

        // Classe pour g√©n√©rer les questions
        class QuestionGenerator {
            constructor() {
                this.lastTypes = [];
                this.maxRepeat = 2;
            }

            random(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            randomFloat(min, max, decimals = 2) {
                const num = Math.random() * (max - min) + min;
                return Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
            }

            getAvailableTypes() {
                return [
                    'multiplication', 'division', 'percentage', 'fraction', 
                    'decimal', 'time', 'unit_conversion', 'geometry_perimeter',
                    'geometry_area', 'proportion', 'angle', 'equation',
                    'number_sequence', 'opposite', 'rounding', 'order_of_operations',
                    'square', 'square_root', 'cube', 'scientific_notation',
                    'fraction_addition', 'fraction_multiplication', 'decimal_multiplication',
                    'percentage_increase', 'percentage_decrease', 'ratio',
                    'speed', 'probability', 'mean', 'pythagorean', 'volume'
                ];
            }

            generateQuestion() {
                const allTypes = this.getAvailableTypes();
                
                let availableTypes = allTypes.filter(type => {
                    const count = this.lastTypes.filter(t => t === type).length;
                    return count < this.maxRepeat;
                });
                
                if (availableTypes.length === 0) {
                    this.lastTypes = [];
                    availableTypes = allTypes;
                }
                
                const type = availableTypes[this.random(0, availableTypes.length - 1)];
                
                this.lastTypes.push(type);
                if (this.lastTypes.length > 5) {
                    this.lastTypes.shift();
                }
                
                switch(type) {
                    case 'multiplication': return this.generateMultiplication();
                    case 'division': return this.generateDivision();
                    case 'percentage': return this.generatePercentage();
                    case 'fraction': return this.generateFraction();
                    case 'decimal': return this.generateDecimal();
                    case 'time': return this.generateTime();
                    case 'unit_conversion': return this.generateUnitConversion();
                    case 'geometry_perimeter': return this.generatePerimeter();
                    case 'geometry_area': return this.generateArea();
                    case 'proportion': return this.generateProportion();
                    case 'angle': return this.generateAngle();
                    case 'equation': return this.generateEquation();
                    case 'number_sequence': return this.generateSequence();
                    case 'opposite': return this.generateOpposite();
                    case 'rounding': return this.generateRounding();
                    case 'order_of_operations': return this.generateOrderOfOperations();
                    case 'square': return this.generateSquare();
                    case 'square_root': return this.generateSquareRoot();
                    case 'cube': return this.generateCube();
                    case 'scientific_notation': return this.generateScientificNotation();
                    case 'fraction_addition': return this.generateFractionAddition();
                    case 'fraction_multiplication': return this.generateFractionMultiplication();
                    case 'decimal_multiplication': return this.generateDecimalMultiplication();
                    case 'percentage_increase': return this.generatePercentageIncrease();
                    case 'percentage_decrease': return this.generatePercentageDecrease();
                    case 'ratio': return this.generateRatio();
                    case 'speed': return this.generateSpeed();
                    case 'probability': return this.generateProbability();
                    case 'mean': return this.generateMean();
                    case 'pythagorean': return this.generatePythagorean();
                    case 'volume': return this.generateVolume();
                    default: return this.generateMultiplication();
                }
            }

            generateMultiplication() {
                const a = this.random(11, 19);
                const b = this.random(6, 14);
                return {
                    question: `Calculer : ${a} √ó ${b}`,
                    answer: (a * b).toString(),
                    type: 'numerical',
                    mathDisplay: `${a} \\times ${b} = ?`,
                    explanationSteps: [`${a} \\times ${b} = ${a * b}`]
                };
            }

            generateDivision() {
                const b = this.random(6, 15);
                const result = this.random(7, 25);
                const a = b * result;
                return {
                    question: `Calculer : ${a} √∑ ${b}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${a} \\div ${b} = ?`,
                    explanationSteps: [
                        `${a} \\div ${b} = ${result}`,
                        `\\text{V√©rification : } ${b} \\times ${result} = ${a}`
                    ]
                };
            }

            generatePercentage() {
                const percentages = [15, 30, 35, 40, 60, 65, 70, 85];
                const percent = percentages[this.random(0, percentages.length - 1)];
                const value = this.random(12, 48) * 5;
                const result = (value * percent) / 100;
                return {
                    question: `Calculer ${percent}% de ${value} euros`,
                    answer: result.toString(),
                    type: 'numerical',
                    unit: 'euros',
                    mathDisplay: `${percent}\\% \\text{ de } ${value}\\text{ euros} = ?`,
                    explanationSteps: [
                        `${percent}\\% \\text{ de } ${value} = \\frac{${percent}}{100} \\times ${value}`,
                        `= ${toFrenchNumber(percent/100)} \\times ${value}`,
                        `= ${result}\\text{ euros}`
                    ]
                };
            }

            generateFraction() {
                const operations = ['tiers', 'sixi√®me', 'cinqui√®me', 'huiti√®me','quart','moiti√©'];
                const op = operations[this.random(0, operations.length - 1)];
                let divisor, fraction;
                switch(op) {
                    case 'tiers': divisor = 3; fraction = '\\frac{1}{3}'; break;
                    case 'sixi√®me': divisor = 6; fraction = '\\frac{1}{6}'; break;
                    case 'cinqui√®me': divisor = 5; fraction = '\\frac{1}{5}'; break;
                    case 'huiti√®me': divisor = 8; fraction = '\\frac{1}{8}'; break;
                    case 'quart': divisor = 4; fraction = '\\frac{1}{4}'; break;
                    case 'moiti√©': divisor = 2; fraction = '\\frac{1}{2}'; break;
                }
                
                const value = this.random(5, 20) * divisor;
                const result = value / divisor;
                
                return {
                    question: `Le ${op} de ${value} est :`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${fraction} \\times ${value} = ?`,
                    explanationSteps: [
                        `\\text{Le ${op} de } ${value} = ${fraction} \\times ${value}`,
                        `= \\frac{${value}}{${divisor}}`,
                        `= ${result}`
                    ]
                };
            }

            generateDecimal() {
                const a = this.randomFloat(1.2, 9.8, 1);
                const b = this.randomFloat(0.6, 8.7, 1);
                const operation = this.random(0, 1) === 0 ? '+' : '-';
                const result = operation === '+' ? (a + b) : (a - b);
                const roundedResult = Math.round(result * 10) / 10;
                
                return {
                    question: `Calculer : ${toFrenchNumber(a)} ${operation} ${toFrenchNumber(b)}`,
                    answer: toFrenchNumber(roundedResult),
                    type: 'numerical',
                    mathDisplay: `${toFrenchNumber(a)} ${operation} ${toFrenchNumber(b)} = ?`,
                    explanationSteps: [
                        `${toFrenchNumber(a)} ${operation} ${toFrenchNumber(b)} = ${toFrenchNumber(roundedResult)}`
                    ]
                };
            }

            generateSquare() {
                const n = this.random(1, 12);
                const result = n * n;
                return {
                    question: `Calculer ${n}¬≤`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${n}^2 = ?`,
                    explanationSteps: [
                        `${n}^2 = ${n} \\times ${n}`,
                        `= ${result}`
                    ]
                };
            }

            generateSquareRoot() {
                const squares = [1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144];
                const n = squares[this.random(0, squares.length - 1)];
                const result = Math.sqrt(n);
                return {
                    question: `Calculer ‚àö${n}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `\\sqrt{${n}} = ?`,
                    explanationSteps: [
                        `\\sqrt{${n}} = ${result}`,
                        `\\text{car } ${result}^2 = ${n}`
                    ]
                };
            }

            generateCube() {
                const n = this.random(1, 8);
                const result = n * n * n;
                return {
                    question: `Calculer ${n}¬≥`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${n}^3 = ?`,
                    explanationSteps: [
                        `${n}^3 = ${n} \\times ${n} \\times ${n}`,
                        `= ${n * n} \\times ${n}`,
                        `= ${result}`
                    ]
                };
            }

            generateScientificNotation() {
                const mantissa = this.randomFloat(1, 9.9, 1);
                const exponent = this.random(-3, 3);
                const result = mantissa * Math.pow(10, exponent);

                return {
                    question: `√âcrire en notation d√©cimale : ${toFrenchNumber(mantissa, 1)} √ó 10^${exponent}`,
                    answer: toFrenchNumber(result),
                    type: 'numerical',
                    mathDisplay: `${toFrenchNumber(mantissa, 1)} \\times 10^{${exponent}} = ?`,
                    explanationSteps: [
                        `${toFrenchNumber(mantissa, 1)} \\times 10^{${exponent}}`,
                        exponent > 0 
                            ? `= ${toFrenchNumber(mantissa, 1)} \\times ${Math.pow(10, exponent)}`
                            : `= ${toFrenchNumber(mantissa, 1)} \\div ${Math.pow(10, -exponent)}`,
                        `= ${toFrenchNumber(result)}`
                    ]
                };
            }

            generateFractionAddition() {
                const denominators = [2, 3, 4, 5, 6, 8];
                const d = denominators[this.random(0, denominators.length - 1)];
                const n1 = this.random(1, d - 1);
                const n2 = this.random(1, d - 1);
                const result = (n1 + n2) / d;
                
                let answerStr;
                if ((n1 + n2) % d === 0) {
                    answerStr = ((n1 + n2) / d).toString();
                } else {
                    let num = n1 + n2;
                    let den = d;
                    for (let i = 2; i <= Math.min(num, den); i++) {
                        while (num % i === 0 && den % i === 0) {
                            num /= i;
                            den /= i;
                        }
                    }
                    answerStr = `${num}/${den}`;
                }
                
                return {
                    question: `Calculer : ${n1}/${d} + ${n2}/${d}`,
                    answer: answerStr,
                    type: 'fraction',
                    mathDisplay: `\\frac{${n1}}{${d}} + \\frac{${n2}}{${d}} = ?`,
                    explanationSteps: [
                        `\\frac{${n1}}{${d}} + \\frac{${n2}}{${d}} = \\frac{${n1} + ${n2}}{${d}}`,
                        `= \\frac{${n1 + n2}}{${d}}`,
                        answerStr.includes('/') ? `= ${answerStr}` : `= ${answerStr}`
                    ]
                };
            }

            generateFractionMultiplication() {
                const n1 = this.random(2, 9);
                const d1 = this.random(3, 9);
                const n2 = this.random(2, 9);
                const d2 = this.random(3, 9);
                
                let num = n1 * n2;
                let den = d1 * d2;
                
                for (let i = 2; i <= Math.min(num, den); i++) {
                    while (num % i === 0 && den % i === 0) {
                        num /= i;
                        den /= i;
                    }
                }
                
                const answerStr = den === 1 ? num.toString() : `${num}/${den}`;
                
                return {
                    question: `Calculer : ${n1}/${d1} √ó ${n2}/${d2}`,
                    answer: answerStr,
                    type: 'fraction',
                    mathDisplay: `\\frac{${n1}}{${d1}} \\times \\frac{${n2}}{${d2}} = ?`,
                    explanationSteps: [
                        `\\frac{${n1}}{${d1}} \\times \\frac{${n2}}{${d2}} = \\frac{${n1} \\times ${n2}}{${d1} \\times ${d2}}`,
                        `= \\frac{${n1 * n2}}{${d1 * d2}}`,
                        `= ${answerStr}`
                    ]
                };
            }

            generateDecimalMultiplication() {
                const a = this.randomFloat(0.1, 0.9, 1);
                const b = this.random(10, 90);
                const result = Math.round(a * b * 10) / 10;
                
                return {
                    question: `Calculer : ${toFrenchNumber(a)} √ó ${b}`,
                    answer: toFrenchNumber(result),
                    type: 'numerical',
                    mathDisplay: `${toFrenchNumber(a)} \\times ${b} = ?`,
                    explanationSteps: [
                        `${toFrenchNumber(a)} \\times ${b}`,
                        `= ${toFrenchNumber(result)}`
                    ]
                };
            }

            generatePercentageIncrease() {
                const initial = this.random(10, 50) * 10;
                const percent = this.random(1, 5) * 10;
                const increase = initial * percent / 100;
                const result = initial + increase;
                
                return {
                    question: `Un article co√ªte ${initial} euros. Son prix augmente de ${percent}%. Quel est le nouveau prix ?`,
                    answer: result.toString(),
                    type: 'numerical',
                    unit: 'euros',
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{Augmentation} = ${initial} \\times \\frac{${percent}}{100}`,
                        `= ${initial} \\times ${toFrenchNumber(percent/100)}`,
                        `= ${increase}`,
                        `\\text{Nouveau prix} = ${initial} + ${increase}`,
                        `= ${result}`
                    ]
                };
            }

            generatePercentageDecrease() {
                const initial = this.random(15, 60) * 10;
                const percent = this.random(1, 4) * 10;
                const decrease = initial * percent / 100;
                const result = initial - decrease;
                
                return {
                    question: `Un article co√ªte ${initial} euros. Il y a une remise de ${percent}%. Quel est le prix apr√®s remise ?`,
                    answer: result.toString(),
                    type: 'numerical',
                    unit: 'euros',
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{Remise} = ${initial} \\times \\frac{${percent}}{100}`,
                        `= ${initial} \\times ${toFrenchNumber(percent/100)}`,
                        `= ${decrease}`,
                        `\\text{Prix apr√®s remise} = ${initial} - ${decrease}`,
                        `= ${result}`
                    ]
                };
            }

            generateRatio() {
                const total = this.random(6, 15) * 10;
                const parts = [2, 3, 5];
                const ratio1 = parts[this.random(0, parts.length - 1)];
                const ratio2 = parts[this.random(0, parts.length - 1)];
                const part1 = (total * ratio1) / (ratio1 + ratio2);
                
                return {
                    question: `Partager ${total} euros dans le rapport ${ratio1}:${ratio2}. Quelle est la plus petite part ?`,
                    answer: Math.min(part1, total - part1).toString(),
                    type: 'numerical',
                    unit: 'euros',
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{Total des parts} = ${ratio1} + ${ratio2} = ${ratio1 + ratio2}`,
                        `\\text{Valeur d'une part} = \\frac{${total}}{${ratio1 + ratio2}} = ${total/(ratio1 + ratio2)}`,
                        `\\text{Premi√®re partie} = ${ratio1} \\times ${total/(ratio1 + ratio2)} = ${part1}`,
                        `\\text{Deuxi√®me partie} = ${ratio2} \\times ${total/(ratio1 + ratio2)} = ${total - part1}`,
                        `\\text{Plus petite part} = ${Math.min(part1, total - part1)}`
                    ]
                };
            }

            generateSpeed() {
                const distance = this.random(12, 48) * 5;
                const time = this.random(2, 6);
                const speed = distance / time;
                
                return {
                    question: `Une voiture parcourt ${distance} km en ${time} heures. Quelle est sa vitesse moyenne ?`,
                    answer: speed.toString(),
                    type: 'numerical',
                    unit: 'km/h',
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{Vitesse} = \\frac{\\text{Distance}}{\\text{Temps}}`,
                        `= \\frac{${distance}\\text{ km}}{${time}\\text{ h}}`,
                        `= ${speed}\\text{ km/h}`
                    ]
                };
            }

            generateProbability() {
                const total = this.random(10, 30);
                const favorable = this.random(3, Math.min(12, total - 2));
                
                let num = favorable;
                let den = total;
                for (let i = 2; i <= Math.min(num, den); i++) {
                    while (num % i === 0 && den % i === 0) {
                        num /= i;
                        den /= i;
                    }
                }
                
                return {
                    question: `Dans un sac, il y a ${total} billes dont ${favorable} sont rouges. Quelle est la probabilit√© de tirer une bille rouge ?`,
                    answer: `${num}/${den}`,
                    type: 'fraction',
                    mathDisplay: `P(\\text{rouge}) = \\frac{${favorable}}{${total}} = ?`,
                    explanationSteps: [
                        `P(\\text{rouge}) = \\frac{\\text{Nombre de billes rouges}}{\\text{Nombre total de billes}}`,
                        `= \\frac{${favorable}}{${total}}`,
                        num !== favorable ? `= \\frac{${num}}{${den}}` : ''
                    ].filter(s => s !== '')
                };
            }

            generateMean() {
                const count = 5;
                const values = [];
                for (let i = 0; i < count; i++) {
                    values.push(this.random(5, 20));
                }
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / count;
                
                return {
                    question: `Calculer la moyenne de : ${values.join(' ; ')}`,
                    answer: toFrenchNumber(mean),
                    type: 'numerical',
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{Somme} = ${values.join(' + ')} = ${sum}`,
                        `\\text{Moyenne} = \\frac{${sum}}{${count}}`,
                        `= ${toFrenchNumber(mean)}`
                    ]
                };
            }

            generatePythagorean() {
                const pythagoreanTriples = [
                    [3, 4, 5], [5, 12, 13], [8, 15, 17], [7, 24, 25]
                ];
                const triple = pythagoreanTriples[this.random(0, pythagoreanTriples.length - 1)];
                const [a, b, c] = triple;
                
                const figure = `
                    <svg width="200" height="150" viewBox="0 0 200 150">
                        <polygon points="30,120 30,30 150,120" fill="none" stroke="#667eea" stroke-width="2"/>
                        <rect x="25" y="115" width="10" height="10" fill="none" stroke="#667eea" stroke-width="1"/>
                        <text x="15" y="75" text-anchor="middle" font-size="14" fill="#333">${a}</text>
                        <text x="90" y="135" text-anchor="middle" font-size="14" fill="#333">${b}</text>
                        <text x="100" y="70" text-anchor="middle" font-size="14" fill="#333">?</text>
                    </svg>
                `;
                
                return {
                    question: `Dans un triangle rectangle, les c√¥t√©s de l'angle droit mesurent ${a} cm et ${b} cm. Quelle est la longueur de l'hypot√©nuse ?`,
                    answer: c.toString(),
                    type: 'numerical',
                    unit: 'cm',
                    figure: figure,
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{Th√©or√®me de Pythagore : } c^2 = a^2 + b^2`,
                        `c^2 = ${a}^2 + ${b}^2`,
                        `c^2 = ${a * a} + ${b * b}`,
                        `c^2 = ${a * a + b * b}`,
                        `c = \\sqrt{${a * a + b * b}} = ${c}\\text{ cm}`
                    ]
                };
            }

            generateVolume() {
                const shape = this.random(0, 1);
                
                if (shape === 0) {
                    const side = this.random(3, 9);
                    const volume = side * side * side;
                    
                    return {
                        question: `Quel est le volume d'un cube d'ar√™te ${side} cm ?`,
                        answer: volume.toString(),
                        type: 'numerical',
                        unit: 'cm¬≥',
                        mathDisplay: ``,
                        explanationSteps: [
                            `V_{\\text{cube}} = \\text{ar√™te}^3`,
                            `= ${side}^3`,
                            `= ${side} \\times ${side} \\times ${side}`,
                            `= ${volume}\\text{ cm}^3`
                        ]
                    };
                } else {
                    const l = this.random(3, 8);
                    const w = this.random(2, 6);
                    const h = this.random(2, 5);
                    const volume = l * w * h;
                    
                    return {
                        question: `Quel est le volume d'un pav√© droit de dimensions ${l} cm √ó ${w} cm √ó ${h} cm ?`,
                        answer: volume.toString(),
                        type: 'numerical',
                        unit: 'cm¬≥',
                        mathDisplay: ``,
                        explanationSteps: [
                            `V_{\\text{pav√©}} = L \\times l \\times h`,
                            `= ${l} \\times ${w} \\times ${h}`,
                            `= ${l * w} \\times ${h}`,
                            `= ${volume}\\text{ cm}^3`
                        ]
                    };
                }
            }

            generateTime() {
                const hours = this.random(14, 22);
                const minutes = this.random(0, 59);
                const addHours = this.random(0, 2);
                const addMinutes = this.random(15, 55);
                
                let newMinutes = minutes + addMinutes;
                let newHours = hours + addHours;
                
                if (newMinutes >= 60) {
                    newHours += Math.floor(newMinutes / 60);
                    newMinutes = newMinutes % 60;
                }
                
                if (newHours >= 24) {
                    newHours = newHours % 24;
                }
                
                const startTime = `${hours}h${minutes.toString().padStart(2, '0')}`;
                const duration = addHours > 0 ? `${addHours}h${addMinutes}min` : `${addMinutes} min`;
                
                let explanationSteps = [];
                if (minutes + addMinutes >= 60) {
                    explanationSteps = [
                        `${hours}\\text{h}${minutes.toString().padStart(2, '0')} + ${duration}`,
                        `= ${hours + addHours}\\text{h}${minutes + addMinutes}\\text{min}`,
                        `= ${newHours}\\text{h}${newMinutes.toString().padStart(2, '0')}`
                    ];
                } else {
                    explanationSteps = [
                        `${hours}\\text{h}${minutes.toString().padStart(2, '0')} + ${duration}`,
                        `= ${newHours}\\text{h}${newMinutes.toString().padStart(2, '0')}`
                    ];
                }
                
                return {
                    question: `Il est ${startTime}. Quelle heure sera-t-il dans ${duration} ?`,
                    answer: `${newHours}h${newMinutes.toString().padStart(2, '0')}`,
                    type: 'time',
                    explanationSteps: explanationSteps
                };
            }

            generateUnitConversion() {
                const conversions = [
                    { from: 'm', to: 'cm', factor: 100, value: this.randomFloat(1.5, 12.5, 1) },
                    { from: 'dm', to: 'm', factor: 0.1, value: this.random(15, 85) },
                    { from: 'km', to: 'm', factor: 1000, value: this.randomFloat(0.5, 8.5, 1) },
                    { from: 'cm¬≤', to: 'dm¬≤', factor: 0.01, value: this.random(250, 950) },
                    { from: 'm¬≤', to: 'dm¬≤', factor: 100, value: this.random(5, 35) },
                    { from: 'L', to: 'mL', factor: 1000, value: this.randomFloat(0.5, 5.5, 1) },
                    { from: 'kg', to: 'g', factor: 1000, value: this.randomFloat(0.5, 9.5, 1) }
                ];
                
                const conv = conversions[this.random(0, conversions.length - 1)];
                let result = conv.value * conv.factor;
                
                if (result % 1 !== 0) {
                    result = Math.round(result * 100) / 100;
                }
                
                return {
                    question: `Convertir : ${toFrenchNumber(conv.value)} ${conv.from} = ? ${conv.to}`,
                    answer: toFrenchNumber(result),
                    type: 'numerical',
                    mathDisplay: `${toFrenchNumber(conv.value)}\\text{ ${conv.from}} = ?\\text{ ${conv.to}}`,
                    explanationSteps: [
                        `${toFrenchNumber(conv.value)}\\text{ ${conv.from}} = ${toFrenchNumber(conv.value)} \\times ${toFrenchNumber(conv.factor)}\\text{ ${conv.to}}`,
                        `= ${toFrenchNumber(result)}\\text{ ${conv.to}}`
                    ]
                };
            }

            generatePerimeter() {
                const shape = this.random(0, 2);
                
                if (shape === 0) {
                    const length = this.random(7, 18);
                    const width = this.random(4, 12);
                    const perimeter = 2 * (length + width);
                    
                    const figure = `
                        <svg width="200" height="120" viewBox="0 0 200 120">
                            <rect x="20" y="20" width="160" height="80" fill="none" stroke="#667eea" stroke-width="2"/>
                            <text x="100" y="15" text-anchor="middle" font-size="14" fill="#333">${length} cm</text>
                            <text x="10" y="65" text-anchor="middle" font-size="14" fill="#333" transform="rotate(-90, 10, 65)">${width} cm</text>
                        </svg>
                    `;
                    
                    return {
                        question: `Quel est le p√©rim√®tre d'un rectangle de longueur ${length} cm et de largeur ${width} cm ?`,
                        answer: perimeter.toString(),
                        type: 'numerical',
                        unit: 'cm',
                        figure: figure,
                        mathDisplay: `\\text{P√©rim√®tre} = ?`,
                        explanationSteps: [
                            `\\text{P√©rim√®tre} = 2 \\times (\\text{longueur} + \\text{largeur})`,
                            `= 2 \\times (${length} + ${width})`,
                            `= 2 \\times ${length + width}`,
                            `= ${perimeter}\\text{ cm}`
                        ]
                    };
                } else if (shape === 1) {
                    const side = this.random(8, 19);
                    const perimeter = 4 * side;
                    
                    const figure = `
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <rect x="25" y="25" width="100" height="100" fill="none" stroke="#667eea" stroke-width="2"/>
                            <text x="75" y="15" text-anchor="middle" font-size="14" fill="#333">${side} cm</text>
                        </svg>
                    `;
                    
                    return {
                        question: `Quel est le p√©rim√®tre d'un carr√© de c√¥t√© ${side} cm ?`,
                        answer: perimeter.toString(),
                        type: 'numerical',
                        unit: 'cm',
                        figure: figure,
                        mathDisplay: `\\text{P√©rim√®tre} = ?`,
                        explanationSteps: [
                            `\\text{P√©rim√®tre} = 4 \\times \\text{c√¥t√©}`,
                            `= 4 \\times ${side}`,
                            `= ${perimeter}\\text{ cm}`
                        ]
                    };
                } else {
                    const side = this.random(7, 23);
                    const perimeter = 3 * side;
                    
                    const figure = `
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <polygon points="75,25 25,115 125,115" fill="none" stroke="#667eea" stroke-width="2"/>
                            <text x="75" y="140" text-anchor="middle" font-size="14" fill="#333">${side} cm</text>
                        </svg>
                    `;
                    
                    return {
                        question: `Quel est le p√©rim√®tre d'un triangle √©quilat√©ral de c√¥t√© ${side} cm ?`,
                        answer: perimeter.toString(),
                        type: 'numerical',
                        unit: 'cm',
                        figure: figure,
                        mathDisplay: `\\text{P√©rim√®tre} = ?`,
                        explanationSteps: [
                            `\\text{P√©rim√®tre} = 3 \\times \\text{c√¥t√©}`,
                            `= 3 \\times ${side}`,
                            `= ${perimeter}\\text{ cm}`
                        ]
                    };
                }
            }

            generateArea() {
                const shape = this.random(0, 1);
                
                if (shape === 0) {
                    const length = this.random(5, 15);
                    const width = this.random(3, 12);
                    const area = length * width;
                    
                    const figure = `
                        <svg width="200" height="120" viewBox="0 0 200 120">
                            <rect x="20" y="20" width="160" height="80" fill="rgba(102, 126, 234, 0.2)" stroke="#667eea" stroke-width="2"/>
                            <text x="100" y="15" text-anchor="middle" font-size="14" fill="#333">${length} cm</text>
                            <text x="10" y="65" text-anchor="middle" font-size="14" fill="#333" transform="rotate(-90, 10, 65)">${width} cm</text>
                        </svg>
                    `;
                    
                    return {
                        question: `Quelle est l'aire d'un rectangle de ${length} cm sur ${width} cm ?`,
                        answer: area.toString(),
                        type: 'numerical',
                        unit: 'cm¬≤',
                        figure: figure,
                        mathDisplay: `\\text{Aire} = ?`,
                        explanationSteps: [
                            `\\text{Aire} = \\text{longueur} \\times \\text{largeur}`,
                            `= ${length} \\times ${width}`,
                            `= ${area}\\text{ cm}^2`
                        ]
                    };
                } else {
                    const side = this.random(7, 13);
                    const area = side * side;
                    
                    const figure = `
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <rect x="25" y="25" width="100" height="100" fill="rgba(102, 126, 234, 0.2)" stroke="#667eea" stroke-width="2"/>
                            <text x="75" y="15" text-anchor="middle" font-size="14" fill="#333">${side} cm</text>
                        </svg>
                    `;
                    
                    return {
                        question: `Quelle est l'aire d'un carr√© de c√¥t√© ${side} cm ?`,
                        answer: area.toString(),
                        type: 'numerical',
                        unit: 'cm¬≤',
                        figure: figure,
                        mathDisplay: `\\text{Aire} = ?`,
                        explanationSteps: [
                            `\\text{Aire} = \\text{c√¥t√©} \\times \\text{c√¥t√©}`,
                            `= ${side} \\times ${side}`,
                            `= ${area}\\text{ cm}^2`
                        ]
                    };
                }
            }

            generateProportion() {
                const a = this.random(3, 15);
                const b = this.random(4, 20);
                const c = this.random(5, 18);
                const d = (b * c) / a;
                
                // S'assurer que d est un entier, que a‚â†c et que b‚â†d (√©viter les proportions triviales)
                if (d === Math.floor(d) && a !== c && b !== d && d > 0 && d <= 100) {
                    const table = `
                        <table style="margin: 20px auto; border-collapse: collapse;">
                            <tr>
                                <td style="border: 1px solid #667eea; padding: 10px 20px; text-align: center;">${a}</td>
                                <td style="border: 1px solid #667eea; padding: 10px 20px; text-align: center;">${b}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #667eea; padding: 10px 20px; text-align: center;">${c}</td>
                                <td style="border: 1px solid #667eea; padding: 10px 20px; text-align: center; background: #f0f0f0;">?</td>
                            </tr>
                        </table>
                    `;
                    
                    return {
                        question: `Compl√©ter le tableau de proportionnalit√© :`,
                        answer: d.toString(),
                        type: 'numerical',
                        figure: table,
                        mathDisplay: ``,
                        explanationSteps: [
                            `\\text{Produit en croix :}`,
                            `${a} \\times ? = ${b} \\times ${c}`,
                            `${a} \\times ? = ${b * c}`,
                            `? = \\frac{${b * c}}{${a}}`,
                            `? = ${d}`
                        ]
                    };
                } else {
                    return this.generateProportion();
                }
            }

            generateAngle() {
                const angle1 = this.random(25, 75);
                const angle2 = this.random(30, 80);
                const angle3 = 180 - angle1 - angle2;
                
                if (angle3 > 20 && angle3 < 100) {
                    const figure = `
                        <svg width="200" height="150" viewBox="0 0 200 150">
                            <polygon points="100,30 30,120 170,120" fill="none" stroke="#667eea" stroke-width="2"/>
                            <text x="100" y="25" text-anchor="middle" font-size="14" fill="#333">?¬∞</text>
                            <text x="45" y="115" text-anchor="middle" font-size="14" fill="#333">${angle1}¬∞</text>
                            <text x="155" y="115" text-anchor="middle" font-size="14" fill="#333">${angle2}¬∞</text>
                        </svg>
                    `;
                    
                    return {
                        question: `Dans un triangle, deux angles mesurent ${angle1}¬∞ et ${angle2}¬∞. Quelle est la mesure du troisi√®me angle ?`,
                        answer: angle3.toString(),
                        type: 'numerical',
                        unit: '¬∞',
                        figure: figure,
                        mathDisplay: ``,
                        explanationSteps: [
                            `\\text{Somme des angles d'un triangle} = 180¬∞`,
                            `${angle1}¬∞ + ${angle2}¬∞ + ?¬∞ = 180¬∞`,
                            `${angle1 + angle2}¬∞ + ?¬∞ = 180¬∞`,
                            `?¬∞ = 180¬∞ - ${angle1 + angle2}¬∞`,
                            `?¬∞ = ${angle3}¬∞`
                        ]
                    };
                } else {
                    return this.generateAngle();
                }
            }

            generateEquation() {
                const a = this.random(2, 5);
                const b = this.random(1, 10);
                const c = this.random(b + 1, b + 20);
                const x = (c - b) / a;
                
                if (x === Math.floor(x)) {
                    return {
                        question: `R√©soudre : ${a}x + ${b} = ${c}`,
                        answer: x.toString(),
                        type: 'numerical',
                        mathDisplay: `${a}x + ${b} = ${c}`,
                        explanationSteps: [
                            `${a}x + ${b} = ${c}`,
                            `${a}x = ${c} - ${b}`,
                            `${a}x = ${c - b}`,
                            `x = \\frac{${c - b}}{${a}}`,
                            `x = ${x}`
                        ]
                    };
                } else {
                    return this.generateEquation();
                }
            }

            generateSequence() {
                const start = this.random(1, 20);
                const step = this.random(2, 5);
                const seq = [];
                for (let i = 0; i < 4; i++) {
                    seq.push(start + i * step);
                }
                const answer = start + 4 * step;
                
                return {
                    question: `Compl√©ter la suite : ${seq.join(' ; ')} ; ?`,
                    answer: answer.toString(),
                    type: 'numerical',
                    mathDisplay: `${seq.join(' ; ')} ; ?`,
                    explanationSteps: [
                        `\\text{La suite augmente de } ${step} \\text{ √† chaque fois :}`,
                        `${seq[0]} \\xrightarrow{+${step}} ${seq[1]}`,
                        `${seq[1]} \\xrightarrow{+${step}} ${seq[2]}`,
                        `${seq[2]} \\xrightarrow{+${step}} ${seq[3]}`,
                        `${seq[3]} \\xrightarrow{+${step}} ${answer}`
                    ]
                };
            }

            generateOpposite() {
                const num = this.randomFloat(-20, 20, 1);
                if (num === 0) return this.generateOpposite();
                
                return {
                    question: `L'oppos√© de ${toFrenchNumber(num)} est :`,
                    answer: toFrenchNumber(-num),
                    type: 'numerical',
                    mathDisplay: ``,
                    explanationSteps: [
                        `\\text{L'oppos√© de } ${toFrenchNumber(num)} = ${toFrenchNumber(-num)}`,
                        `\\text{(L'oppos√© change le signe)}`
                    ]
                };
            }

            generateRounding() {
                const num = this.randomFloat(10, 100, 4);
                const thirdDecimal = Math.floor((num * 1000) % 10);
                const fourthDecimal = Math.floor((num * 10000) % 10);

                if (thirdDecimal !== 0 || fourthDecimal !== 0) {
                    const rounded = Math.round(num * 100) / 100;

                    return {
                        question: `Arrondir ${toFrenchNumber(num)} au centi√®me pr√®s :`,
                        answer: toFrenchNumber(rounded, 2),
                        type: 'numerical',
                        mathDisplay: `${toFrenchNumber(num)} \\approx ?`,
                        explanationSteps: [
                            `${toFrenchNumber(num)} \\text{ arrondi au centi√®me}`,
                            `\\text{3e d√©cimale : } ${thirdDecimal}`,
                            `${thirdDecimal >= 5 
                                ? `${thirdDecimal} \\geq 5 \\text{ donc on arrondit au-dessus}` 
                                : `${thirdDecimal} < 5 \\text{ donc on arrondit en-dessous}`}`,
                            `\\text{R√©sultat : } ${toFrenchNumber(rounded, 2)}`
                        ]
                    };
                } else {
                    return this.generateRounding();
                }
            }

            generateOrderOfOperations() {
                const a = this.random(2, 9);
                const b = this.random(2, 9);
                const c = this.random(2, 9);
                const result = a + b * c;
                
                return {
                    question: `Calculer : ${a} + ${b} √ó ${c}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${a} + ${b} \\times ${c} = ?`,
                    explanationSteps: [
                        `\\text{Priorit√© : multiplication avant addition}`,
                        `${a} + ${b} \\times ${c}`,
                        `= ${a} + ${b * c}`,
                        `= ${result}`
                    ]
                };
            }
        }

        // Fonctions principales
        function startQuiz() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            
            currentQuestionIndex = 0;
            questions = [];
            userAnswers = [];
            hasAnswered = false;
            questionTimes = [];
            
            const generator = new QuestionGenerator();
            
            for (let i = 0; i < questionCount; i++) {
                questions.push(generator.generateQuestion());
            }
            
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }

            hasAnswered = false;
            questionStartTime = Date.now();
            const question = questions[currentQuestionIndex];
            const quizContainer = document.getElementById('quizContainer');
            
            let questionHTML = `
                <div class="question-header">
                    <div class="question-number">Question ${currentQuestionIndex + 1} / ${questions.length}</div>
                    <div class="timer" id="timer">‚è±Ô∏è 0s</div>
                </div>
                <div class="question-content">
                    <div class="question-text">${question.question}</div>
            `;
            
            if (question.mathDisplay) {
                questionHTML += `<div class="math-display">${renderMathDisplay(question.mathDisplay)}</div>`;
            }
            
            if (question.figure) {
                questionHTML += `<div class="figure-container">${question.figure}</div>`;
            }
            
            questionHTML += `
                    <input type="text" class="answer-input" id="answerInput" placeholder="Votre r√©ponse${question.unit ? ' (en ' + question.unit + ')' : ''}" onkeypress="if(event.key === 'Enter') validateAnswer()">
                </div>
                <div class="question-actions" id="questionActions">
                    <button class="btn-validate" onclick="validateAnswer()">‚úì Valider</button>
                    <button class="btn-skip" onclick="skipQuestion()">‚Üí Passer</button>
                </div>
                <div id="feedback"></div>
            `;
            
            quizContainer.innerHTML = questionHTML;
            
            document.getElementById('answerInput').focus();
            startTimer();
        }

        function startTimer() {
            clearInterval(timer);
            timeElapsed = 0;
            
            timer = setInterval(() => {
                timeElapsed++;
                const timerElement = document.getElementById('timer');
                if (timerElement && !hasAnswered) {
                    timerElement.textContent = `‚è±Ô∏è ${timeElapsed}s`;
                }
            }, 1000);
        }

        function validateAnswer() {
            if (hasAnswered) return;
            
            clearInterval(timer);
            hasAnswered = true;
            
            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);
            questionTimes.push(timeSpent);
            
            const userAnswer = document.getElementById('answerInput').value.trim();
            const currentQuestion = questions[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer;
            
            // Normaliser les r√©ponses pour la comparaison
            const normalizedUserAnswer = userAnswer.toLowerCase().replace(',', '.').replace(/\s/g, '');
            const normalizedCorrectAnswer = correctAnswer.toString().toLowerCase().replace(',', '.').replace(/\s/g, '');
            
            const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
            
            userAnswers.push({
                question: currentQuestion.question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timeSpent: timeSpent,
                explanationSteps: currentQuestion.explanationSteps,
                mathDisplay: currentQuestion.mathDisplay,
                figure: currentQuestion.figure
            });
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
            
            let feedbackHTML = isCorrect 
                ? `‚úì Correct ! Bien jou√© ! (Temps: ${timeSpent}s)` 
                : `‚úó Incorrect. La bonne r√©ponse √©tait : ${correctAnswer}${currentQuestion.unit ? ' ' + currentQuestion.unit : ''} (Temps: ${timeSpent}s)`;
            
            // Ajouter l'explication d√©taill√©e
            if (currentQuestion.explanationSteps) {
                feedbackHTML += `
                    <div class="explanation-box ${isCorrect ? 'correct' : 'incorrect'}">
                        <strong>üìù Explication :</strong>
                        ${renderExplanation(currentQuestion.explanationSteps)}
                    </div>`;
            }
            
            feedback.innerHTML = feedbackHTML;
            
            // Remplacer les boutons par un bouton "Suivant"
            const actionsDiv = document.getElementById('questionActions');
            actionsDiv.innerHTML = '<button class="btn-next" onclick="nextQuestion()">Suivant ‚Üí</button>';
            
            // D√©sactiver l'input
            document.getElementById('answerInput').disabled = true;
        }

        function skipQuestion() {
            if (hasAnswered) return;
            
            clearInterval(timer);
            hasAnswered = true;
            
            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);
            questionTimes.push(timeSpent);
            
            const currentQuestion = questions[currentQuestionIndex];
            
            userAnswers.push({
                question: currentQuestion.question,
                userAnswer: '',
                correctAnswer: currentQuestion.answer,
                isCorrect: false,
                timeSpent: timeSpent,
                explanationSteps: currentQuestion.explanationSteps,
                mathDisplay: currentQuestion.mathDisplay,
                figure: currentQuestion.figure
            });
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback incorrect';
            
            let feedbackHTML = `‚úó Question pass√©e. La bonne r√©ponse √©tait : ${currentQuestion.answer}${currentQuestion.unit ? ' ' + currentQuestion.unit : ''} (Temps: ${timeSpent}s)`;
            
            // Ajouter l'explication d√©taill√©e
            if (currentQuestion.explanationSteps) {
                feedbackHTML += `
                    <div class="explanation-box incorrect">
                        <strong>üìù Explication :</strong>
                        ${renderExplanation(currentQuestion.explanationSteps)}
                    </div>`;
            }
            
            feedback.innerHTML = feedbackHTML;
            
            // Remplacer les boutons par un bouton "Suivant"
            const actionsDiv = document.getElementById('questionActions');
            actionsDiv.innerHTML = '<button class="btn-next" onclick="nextQuestion()">Suivant ‚Üí</button>';
            
            // D√©sactiver l'input
            document.getElementById('answerInput').disabled = true;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showResults() {
            const correctCount = userAnswers.filter(a => a.isCorrect).length;
            const percentage = Math.round((correctCount / questions.length) * 100);
            const totalTime = questionTimes.reduce((a, b) => a + b, 0);
            const avgTime = Math.round(totalTime / questions.length);
            
            const quizContainer = document.getElementById('quizContainer');
            
            let reviewHTML = '';
            userAnswers.forEach((answer, index) => {
                let questionReview = `
                    <div class="question-review ${answer.isCorrect ? 'correct' : 'incorrect'}">
                        <strong>Q${index + 1}:</strong> ${answer.question}<br>
                `;
                
                if (answer.figure) {
                    questionReview += `<div class="figure-container">${answer.figure}</div>`;
                }
                
                questionReview += `
                        <strong>Votre r√©ponse:</strong> ${answer.userAnswer || 'Pas de r√©ponse'}<br>
                        <strong>R√©ponse correcte:</strong> ${answer.correctAnswer}<br>
                        <div class="time-info">‚è±Ô∏è Temps: ${answer.timeSpent}s</div>
                `;
                
                if (answer.explanationSteps) {
                    questionReview += `
                        <div class="review-explanation">
                            <strong>üìù Explication :</strong>
                            ${renderExplanation(answer.explanationSteps)}
                        </div>
                    `;
                }
                
                questionReview += `</div>`;
                reviewHTML += questionReview;
            });
            
            quizContainer.innerHTML = `
                <div class="results">
                    <h2>üéØ R√©sultats du test</h2>
                    <div class="score">${correctCount} / ${questions.length}</div>
                    <p style="font-size: 1.2em; color: #666;">Score: ${percentage}%</p>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="color: #1976d2; margin-bottom: 10px;">üìä Statistiques de temps</h3>
                        <p style="font-size: 1.1em; color: #333;">
                            Temps total : ${formatTime(totalTime)}<br>
                            Temps moyen par question : ${avgTime}s<br>
                            Question la plus rapide : ${Math.min(...questionTimes)}s<br>
                            Question la plus longue : ${Math.max(...questionTimes)}s
                        </p>
                    </div>
                    
                    <div class="results-details">
                        <h3>üìä D√©tail des r√©ponses avec explications</h3>
                        ${reviewHTML}
                    </div>
                    
                    <button onclick="location.reload()">üîÑ Nouveau test</button>
                </div>
            `;
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Rendre KaTeX disponible globalement si n√©cessaire
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$', right: '$', display: true},
                        {left: ', right: ', display: false}
                    ]
                });
            }
        });
    </script>
</body>
</html>
