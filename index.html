<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatismes Math√©matiques - Format 5√®me</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        h1 { color: #764ba2; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.2em; }
        .controls { background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; align-items: center; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        label { font-weight: bold; color: #333; }
        select, input[type="number"] { padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        select:focus, input[type="number"]:focus { outline: none; border-color: #667eea; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
        button:active { transform: translateY(0); }
        .quiz-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-height: 400px; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .question-number { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .timer { font-size: 1.2em; color: #666; font-weight: bold; }
        .mode-info { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .question-content { margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 15px; border-left: 4px solid #667eea; }
        .question-text { font-size: 1.3em; color: #333; line-height: 1.6; margin-bottom: 20px; }
        .math-display { font-size: 1.4em; margin: 15px 0; text-align: center; }
        .answer-input { padding: 12px 20px; font-size: 18px; border: 2px solid #ddd; border-radius: 10px; width: 300px; max-width: 100%; transition: border-color 0.3s; }
        .answer-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .question-actions { display: flex; gap: 15px; margin-top: 30px; }
        .btn-validate { background: #28a745; }
        .btn-validate:hover { box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); }
        .btn-skip { background: #ffc107; }
        .btn-skip:hover { box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4); }
        .btn-next { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: bold; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .feedback.correct { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .feedback.incorrect { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .explanation-box { margin-top: 15px; padding: 15px; border-radius: 8px; border-left: 3px solid; }
        .explanation-box.correct { background: #e8f5e9; border-color: #4caf50; }
        .explanation-box.incorrect { background: #ffebee; border-color: #f44336; }
        .math-steps { margin-top: 10px; line-height: 2.5; }
        .math-step { display: block; margin: 8px 0; font-size: 1.1em; }
        .figure-container { margin: 20px 0; text-align: center; }
        .figure-container svg { max-width: 100%; height: auto; }
        .grid-container { margin: 20px auto; display: inline-block; }
        .grid { display: inline-grid; gap: 1px; background: #333; padding: 1px; border: 2px solid #333; }
        .grid-cell { width: 30px; height: 30px; background: white; }
        .grid-cell.filled { background: #888; }
        .bar-chart { margin: 20px 0; text-align: center; }
        .results { text-align: center; padding: 40px; }
        .score { font-size: 3em; color: #667eea; margin: 20px 0; font-weight: bold; }
        .results-details { background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .results-details h3 { color: #333; margin-bottom: 15px; }
        .question-review { text-align: left; margin: 15px 0; padding: 15px; background: white; border-radius: 8px; }
        .question-review.correct { border-left: 4px solid #28a745; }
        .question-review.incorrect { border-left: 4px solid #dc3545; }
        .review-explanation { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; border-left: 3px solid #9c27b0; }
        .time-info { background: #e3f2fd; padding: 10px 15px; border-radius: 8px; margin: 10px 0; color: #1976d2; font-weight: bold; }
        .hidden { display: none; }
        .figure-container svg {overflow: visible; /* √©vite que des libell√©s/pointes de fl√®ches soient rogn√©s */}
        @media (max-width: 600px) {
            .controls { flex-direction: column; }
            .control-group { width: 100%; justify-content: space-between; }
            h1 { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìê Automatismes Math√©matiques - 5√®me</h1>
            <div class="subtitle">Entra√Ænement format √©preuve (sans calculatrice, avec brouillon autoris√©)</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="questionCount">Nombre de questions:</label>
                <input type="number" id="questionCount" min="5" max="30" value="30">
            </div>
            <div class="control-group">
                <label for="mode">Mode:</label>
                <select id="mode">
                    <option value="training">Entra√Ænement ( avec explications )</option>
                    <option value="exam">Examen (9 minutes, sans explications)</option>
                </select>
            </div>
            <button onclick="startQuiz()">üöÄ Commencer le test</button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="welcome" id="welcome">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">Bienvenue !</h2>
                <p style="text-align: center; font-size: 1.1em; color: #666; line-height: 1.8;">
                    Ce g√©n√©rateur reproduit fid√®lement le format des √©preuves d'automatismes de 5√®me.<br>
                    Les questions sont bas√©es sur le mod√®le officiel avec :<br><br>
                    ‚Ä¢ Compl√©ter des op√©rations √† trou<br>
                    ‚Ä¢ Calculs d√©cimaux et fractions<br>
                    ‚Ä¢ Pourcentages et proportionnalit√©<br>
                    ‚Ä¢ G√©om√©trie (p√©rim√®tres, aires, volumes)<br>
                    ‚Ä¢ Conversions d'unit√©s et dur√©es<br>
                    ‚Ä¢ Suites logiques et statistiques<br><br>
                    Mode Examen : 30 questions en 9 minutes, comme l'√©preuve r√©elle !
                </p>
            </div>
        </div>
    </div>

    <script>
        // ===== Helpers g√©n√©raux =====
        function toFrenchNumber(num, decimals = null) {
            if (typeof num === 'number') {
                if (decimals !== null) num = num.toFixed(decimals);
                else num = num.toString();
            }
            return num.replace('.', ',');
        }

        function parseDecimal(str) {
            return parseFloat(
                str.replace(/\s|\u00A0|\u202F/g, '').replace(',', '.')
            );
        }

        function renderMath(latex) {
            const span = document.createElement('span');
            katex.render(latex, span, { throwOnError: false, displayMode: false });
            return span.outerHTML;
        }

        function renderMathDisplay(latex) {
            const div = document.createElement('div');
            katex.render(latex, div, { throwOnError: false, displayMode: true });
            return div.outerHTML;
        }

        function renderExplanation(steps) {
            let html = '<div class="math-steps">';
            steps.forEach(step => { html += '<div class="math-step">' + renderMath(step) + '</div>'; });
            html += '</div>';
            return html;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) return `${mins}min ${secs}s`;
            return `${secs}s`;
        }

        // Comparaison num√©rique tol√©rante
        function isNumericEquivalent(a, b, tol = 1e-9) {
            const na = Number(a), nb = Number(b);
            if (Number.isFinite(na) && Number.isFinite(nb)) {
                return Math.abs(na - nb) <= tol;
            }
            return false;
        }

        function normalizeNumberLike(s) {
            return s.toLowerCase()
                .replace(',', '.')
                .replace(/\s/g, '')
                .replace(/‚Ç¨/g, '')
                .replace(/%/g, '');
        }

        // ===== Variables globales =====
        let currentQuestionIndex = 0;
        let questions = [];
        let userAnswers = [];
        let timer = null;
        let timeElapsed = 0;
        let hasAnswered = false;
        let questionStartTime = 0;
        let questionTimes = [];
        let examTimer = null;
        let examTimeRemaining = 540; // 9 minutes

        // ===== G√©n√©rateur de questions =====
        class QuestionGenerator {
            constructor() { this.lastTypes = []; this.maxRepeat = 3; }
            random(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
            randomFloat(min, max, decimals = 2) {
                const num = Math.random() * (max - min) + min;
                return Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
            }

            getAvailableTypes() {
                return [
                    'complete_multiplication', 'decimal_writing', 'decimal_addition', 'decimal_subtraction',
                    'percentage_simple', 'division_quotient', 'time_arrival', 'fraction_of_quantity',
                    'division_cost', 'euclidean_division_remainder', 'missing_value_proportion',
                    'figure_enlargement', 'surface_fraction', 'order_of_operations', 'sequence_double',
                    'bar_chart', 'percentage_from_fraction', 'time_conversion', 'product_calculation',
                    'rectangle_perimeter', 'triangle_construction', 'volume_pave', 'large_number_multiplication',
                    'equation_simple', 'fraction_thirds', 'complete_equation', 'unit_conversion_volume',
                    'polygon_area', 'product_sum_difference', 'power_of_six'
                ];
            }

            generateQuestion() {
                const allTypes = this.getAvailableTypes();
                let availableTypes = allTypes.filter(type => {
                    const count = this.lastTypes.filter(t => t === type).length;
                    return count < this.maxRepeat;
                });
                if (availableTypes.length === 0) { this.lastTypes = []; availableTypes = allTypes; }

                const type = availableTypes[this.random(0, availableTypes.length - 1)];
                this.lastTypes.push(type);
                if (this.lastTypes.length > 10) this.lastTypes.shift();

                switch(type) {
                    case 'complete_multiplication': return this.generateCompleteMultiplication();
                    case 'decimal_writing': return this.generateDecimalWriting();
                    case 'decimal_addition': return this.generateDecimalAddition();
                    case 'decimal_subtraction': return this.generateDecimalSubtraction();
                    case 'percentage_simple': return this.generatePercentageSimple();
                    case 'division_quotient': return this.generateDivisionQuotient();
                    case 'time_arrival': return this.generateTimeArrival();
                    case 'fraction_of_quantity': return this.generateFractionOfQuantity();
                    case 'division_cost': return this.generateDivisionCost();
                    case 'euclidean_division_remainder': return this.generateEuclideanDivisionRemainder();
                    case 'missing_value_proportion': return this.generateMissingValueProportion();
                    case 'figure_enlargement': return this.generateFigureEnlargement();
                    case 'surface_fraction': return this.generateSurfaceFraction();
                    case 'order_of_operations': return this.generateOrderOfOperations();
                    case 'sequence_double': return this.generateSequenceDouble();
                    case 'bar_chart': return this.generateBarChart();
                    case 'percentage_from_fraction': return this.generatePercentageFromFraction();
                    case 'time_conversion': return this.generateTimeConversion();
                    case 'product_calculation': return this.generateProductCalculation();
                    case 'rectangle_perimeter': return this.generateRectanglePerimeter();
                    case 'triangle_construction': return this.generateTriangleConstruction();
                    case 'volume_pave': return this.generateVolumePave();
                    case 'large_number_multiplication': return this.generateLargeNumberMultiplication();
                    case 'equation_simple': return this.generateEquationSimple();
                    case 'fraction_thirds': return this.generateFractionThirds();
                    case 'complete_equation': return this.generateCompleteEquation();
                    case 'unit_conversion_volume': return this.generateUnitConversionVolume();
                    case 'polygon_area': return this.generatePolygonArea();
                    case 'product_sum_difference': return this.generateProductSumDifference();
                    case 'power_of_six': return this.generatePowerOfSix();
                    default: return this.generateCompleteMultiplication();
                }
            }

            generateCompleteMultiplication() {
                const products = [12, 14, 15, 16, 18, 20, 21, 24, 27, 28, 30, 32, 35, 36, 40, 42, 45, 48, 49, 54, 56, 63, 64, 72, 81];
                const product = products[this.random(0, products.length - 1)];
                const divisors = [];
                for (let i = 2; i <= 9; i++) if (product % i === 0 && product / i <= 9) divisors.push(i);
                const a = divisors[this.random(0, divisors.length - 1)];
                const b = product / a;
                return {
                    question: `Compl√®te : ${a} √ó ... = ${product}`,
                    answer: b.toString(),
                    type: 'numerical',
                    mathDisplay: `${a} \\times \\ldots = ${product}`,
                    explanationSteps: [`${a} \\times ? = ${product}`, `? = ${product} \\div ${a}`, `? = ${b}`]
                };
            }

            generateDecimalWriting() {
                const units = this.random(1, 9);
                const tenths = this.random(1, 9);
                const hundredths = this.random(1, 9);
                const thousandths = this.random(1, 9);
                const value = units + tenths/10 + hundredths/100 + thousandths/1000;
                return {
                    question: `√âcriture d√©cimale de : ${units} + ${tenths}/10 + ${hundredths}/100 + ${thousandths}/1000`,
                    answer: toFrenchNumber(value, 3),
                    type: 'numerical',
                    mathDisplay: `${units} + \\frac{${tenths}}{10} + \\frac{${hundredths}}{100} + \\frac{${thousandths}}{1000} = ?`,
                    explanationSteps: [
                        `${units} + \\frac{${tenths}}{10} + \\frac{${hundredths}}{100} + \\frac{${thousandths}}{1000}`,
                        `= ${toFrenchNumber(units,0)} + ${toFrenchNumber(tenths/10,1)} + ${toFrenchNumber(hundredths/100,2)} + ${toFrenchNumber(thousandths/1000,3)}`,
                        `= ${toFrenchNumber(value,3)}`
                    ]
                };
            }

            generateDecimalAddition() {
                const a = this.randomFloat(1, 9, 1);
                const b = this.randomFloat(0.01, 0.99, 2);
                const result = Math.round((a + b) * 100) / 100;
                return {
                    question: `${toFrenchNumber(a, 1)} + ${toFrenchNumber(b, 2)}`,
                    answer: toFrenchNumber(result, 2),
                    type: 'numerical',
                    mathDisplay: `${toFrenchNumber(a, 1)} + ${toFrenchNumber(b, 2)} = ?`,
                    explanationSteps: [`${toFrenchNumber(a, 1)} + ${toFrenchNumber(b, 2)} = ${toFrenchNumber(result, 2)}`]
                };
            }

            generateDecimalSubtraction() {
                const a = this.random(11, 20);
                const b = this.randomFloat(3, 8, 1);
                const result = a - b;
                return {
                    question: `${a} - ${toFrenchNumber(b, 1)}`,
                    answer: toFrenchNumber(result, 1),
                    type: 'numerical',
                    mathDisplay: `${a} - ${toFrenchNumber(b, 1)} = ?`,
                    explanationSteps: [`${a} - ${toFrenchNumber(b, 1)} = ${toFrenchNumber(result, 1)}`]
                };
            }

            // PATCH: √©viter cas ultra-√©vidents (50% de 100, 25% de 100, etc.)
            generatePercentageSimple() {
                const percentages = [10, 20, 25, 30, 40, 60, 75];
                const values = [48, 56, 64, 72, 84, 96, 120, 160];
                let percent, value;
                do {
                    percent = percentages[this.random(0, percentages.length - 1)];
                    value = values[this.random(0, values.length - 1)];
                } while ((percent === 50 && value % 100 === 0) || (percent === 25 && value % 100 === 0));
                const result = (value * percent) / 100;
                return {
                    question: `${percent}% de ${value}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${percent}\\% \\text{ de } ${value} = ?`,
                    explanationSteps: [
                        `${percent}\\% \\text{ de } ${value} = \\frac{${percent}}{100} \\times ${value}`,
                        `= ${toFrenchNumber(percent/100)} \\times ${value}`,
                        `= ${result}`
                    ]
                };
            }

            generateDivisionQuotient() {
                const divisor = this.random(6, 9);
                const quotient = this.random(8, 15);
                const dividend = divisor * quotient;
                return {
                    question: `${dividend} √∑ ${divisor}`,
                    answer: quotient.toString(),
                    type: 'numerical',
                    mathDisplay: `${dividend} \\div ${divisor} = ?`,
                    explanationSteps: [`${dividend} \\div ${divisor} = ${quotient}`]
                };
            }

            generateTimeArrival() {
                const startHour = this.random(14, 17);
                const startMin = this.random(0, 59);
                const durationHour = this.random(1, 3);
                const durationMin = this.random(10, 50);
                let endMin = startMin + durationMin;
                let endHour = startHour + durationHour;
                if (endMin >= 60) { endHour += Math.floor(endMin / 60); endMin = endMin % 60; }
                return {
                    question: `Toto part √† ${startHour}h${startMin.toString().padStart(2, '0')} et son trajet dure ${durationHour}h${durationMin.toString().padStart(2, '0')}min. √Ä quelle heure arrive-t-il ?`,
                    answer: `${endHour}h${endMin.toString().padStart(2, '0')}`,
                    type: 'time',
                    explanationSteps: [
                        `${startHour}\\text{h}${startMin.toString().padStart(2, '0')} + ${durationHour}\\text{h}${durationMin}\\text{min}`,
                        `= ${endHour}\\text{h}${endMin.toString().padStart(2, '0')}`
                    ]
                };
            }

            generateFractionOfQuantity() {
                const fractions = [{text: 'moiti√©', value: 2},{text: 'tiers', value: 3},{text: 'quart', value: 4}];
                const fraction = fractions[this.random(0, fractions.length - 1)];
                const total = this.random(3, 12) * fraction.value;
                const result = total / fraction.value;
                return {
                    question: `La ${fraction.text} de ${total}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `\\frac{1}{${fraction.value}} \\times ${total} = ?`,
                    explanationSteps: [
                        `\\text{La ${fraction.text} de } ${total} = \\frac{${total}}{${fraction.value}}`,
                        `= ${result}`
                    ]
                };
            }

            generateDivisionCost() {
                const unitPrice = this.random(2, 5);
                const quantity = this.random(3, 8);
                const totalPrice = unitPrice * quantity;
                return {
                    question: `${quantity} b√¢tons de r√©glisse co√ªtent ${totalPrice} ‚Ç¨. Combien co√ªtent ${quantity * 2} b√¢tons de r√©glisse ?`,
                    answer: (totalPrice * 2).toString(),
                    type: 'numerical',
                    unit: '‚Ç¨',
                    explanationSteps: [
                        `\\text{Prix unitaire} = ${totalPrice} \\div ${quantity} = ${unitPrice}\\text{ ‚Ç¨}`,
                        `\\text{Prix pour } ${quantity * 2} \\text{ b√¢tons} = ${unitPrice} \\times ${quantity * 2}`,
                        `= ${totalPrice * 2}\\text{ ‚Ç¨}`
                    ]
                };
            }

            // PATCH: √©viter restes triviaux (0,1,div-1)
            generateEuclideanDivisionRemainder() {
                const divisor = this.random(5, 12);
                const quotient = this.random(4, 12);
                let remainder;
                do {
                    remainder = this.random(2, divisor - 2);
                } while (remainder <= 1 || remainder >= divisor - 1);
                const dividend = divisor * quotient + remainder;
                return {
                    question: `Le reste de la division euclidienne de ${dividend} par ${divisor} est :`,
                    answer: remainder.toString(),
                    type: 'numerical',
                    mathDisplay: `${dividend} = ${divisor} \\times q + r`,
                    explanationSteps: [
                        `${dividend} \\div ${divisor} = ${quotient} \\text{ reste } ${remainder}`,
                        `${dividend} = ${divisor} \\times ${quotient} + ${remainder}`,
                        `\\text{Le reste est } ${remainder}`
                    ]
                };
            }

    generateMissingValueProportion() {
    // √âchelles possibles (entiers)
    const steps = [1, 2, 5, 10, 20];
    const step = steps[this.random(0, steps.length - 1)];

    // Nombre de graduations (12 √† 18 pour une lisibilit√© OK √† ~520px)
    const tickCount = this.random(12, 18);
    const totalRange = step * (tickCount - 1);

    // Min d√©butant sur un multiple de "step" (√©vite des labels moches)
    const minCandidates = [0, step * 2, step * 4, step * 5];
    const rangeMin = minCandidates[this.random(0, minCandidates.length - 1)];
    const rangeMax = rangeMin + totalRange;

    // On √©tiquette 1 label toutes les N graduations (2, 5, 10 selon le step/tickCount)
    let labelEvery = 2;
    if (tickCount >= 16 && step <= 2) labelEvery = 3;
    if (step >= 10) labelEvery = 1; // si grandes marches, on peut tout labeller

    // Choix de A : EXACTEMENT sur une graduation et pas trop coll√© aux bords
    const k = this.random(2, tickCount - 3);
    const a = rangeMin + k * step;

    // SVG layout
    const widthPx = 520, heightPx = 120;
    const padL = 30, padR = 30;
    const axisY = 70;
    const axisX0 = padL, axisX1 = widthPx - padR;
    const axisLength = axisX1 - axisX0;
    const pxPerUnit = axisLength / (rangeMax - rangeMin);
    const xOf = v => axisX0 + (v - rangeMin) * pxPerUnit;

    // Graduations
    const ticks = [];
    for (let i = 0; i < tickCount; i++) {
        const v = rangeMin + i * step;
        ticks.push({
            v,
            x: xOf(v),
            isMajor: (i % labelEvery === 0)
        });
    }

    const figure = `
        <svg width="${widthPx}" height="${heightPx}" viewBox="0 0 ${widthPx} ${heightPx}">
            <!-- Axe -->
            <line x1="${axisX0}" y1="${axisY}" x2="${axisX1}" y2="${axisY}" stroke="#333" stroke-width="2"/>

            <!-- Graduations + labels -->
            ${ticks.map((t, i) => `
                <line x1="${t.x}" y1="${axisY - (t.isMajor ? 7 : 5)}" x2="${t.x}" y2="${axisY + (t.isMajor ? 7 : 5)}" stroke="#333" stroke-width="1.5"/>
                ${t.isMajor ? `<text x="${t.x}" y="${axisY + 22}" text-anchor="middle" font-size="12" fill="#333">${t.v}</text>` : ''}
            `).join('')}

            <!-- Point A exactement sur une graduation -->
            <circle cx="${xOf(a)}" cy="${axisY}" r="4" fill="#667eea"/>
            <text x="${xOf(a)}" y="${axisY - 12}" text-anchor="middle" font-size="14" fill="#333">A</text>

            <!-- Rappel d'√©chelle (optionnel) -->
            <text x="${axisX1}" y="${axisY - 30}" text-anchor="end" font-size="12" fill="#666">
                pas = ${step}
            </text>
        </svg>
    `;

    return {
        question: `Quelle est l'abscisse de A ?`,
        answer: a.toString(),
        type: 'numerical',
        figure,
        explanationSteps: [
            `\\text{A est plac√© sur une graduation num√©rot√©e tous les ${labelEvery} ticks, pas } ${step}.`,
            `\\text{On lit sur l'axe : } ${a}.`
        ]
    };
}


            generateFigureEnlargement() {
                const originalLength = this.randomFloat(1.5, 3.5, 1);
                const scale = this.random(2, 4);
                const result = originalLength * scale;
                const figure = `
                    <svg width="250" height="120" viewBox="0 0 250 120">
                        <rect x="20" y="40" width="60" height="40" fill="none" stroke="#667eea" stroke-width="2"/>
                        <text x="50" y="30" text-anchor="middle" font-size="12" fill="#333">‚ûÄ</text>
                        <text x="50" y="100" text-anchor="middle" font-size="12" fill="#333">${toFrenchNumber(originalLength)} cm</text>
                        <rect x="120" y="20" width="120" height="80" fill="none" stroke="#764ba2" stroke-width="2"/>
                        <text x="180" y="10" text-anchor="middle" font-size="12" fill="#333">‚ûÅ</text>
                        <text x="180" y="115" text-anchor="middle" font-size="12" fill="#333">? cm</text>
                        <text x="100" y="60" text-anchor="middle" font-size="14" fill="#333">√ó${scale}</text>
                    </svg>`;
                return {
                    question: `La figure ‚ûÅ est un agrandissement de ‚ûÄ. Quelle est la longueur manquante ?`,
                    answer: toFrenchNumber(result),
                    type: 'numerical',
                    unit: 'cm',
                    figure: figure,
                    explanationSteps: [
                        `\\text{Agrandissement} \\times ${scale}`,
                        `${toFrenchNumber(originalLength)} \\times ${scale} = ${toFrenchNumber(result)}\\text{ cm}`
                    ]
                };
            }

            generateSurfaceFraction() {
                const rows = 4, cols = 4;
                const filled = this.random(3, 8);
                const total = rows * cols;
                let num = filled, den = total;
                for (let i = 2; i <= Math.min(num, den); i++) {
                    while (num % i === 0 && den % i === 0) { num /= i; den /= i; }
                }
                let gridHTML = '<div class="grid-container"><div class="grid" style="grid-template-columns: repeat(4, 1fr);">';
                for (let i = 0; i < total; i++) gridHTML += `<div class="grid-cell ${i < filled ? 'filled' : ''}"></div>`;
                gridHTML += '</div></div>';
                return {
                    question: `Quelle fraction de la surface totale repr√©sente la surface gris√©e ?`,
                    answer: `${num}/${den}`,
                    type: 'fraction',
                    figure: gridHTML,
                    explanationSteps: [
                        `\\text{Cases gris√©es} = ${filled}`,
                        `\\text{Cases totales} = ${total}`,
                        `\\text{Fraction} = \\frac{${filled}}{${total}}`,
                        num !== filled ? `= \\frac{${num}}{${den}}` : ''
                    ].filter(Boolean)
                };
            }

            generateOrderOfOperations() {
                const a = this.random(3, 9);
                const b = this.random(2, 5);
                const c = this.random(2, 6);
                const result = a + b * c;
                return {
                    question: `${a} + ${b} √ó ${c}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${a} \\times ${b} + ${c}`,
                    explanationSteps: [
                        `\\text{Priorit√© : multiplication}`,
                        `${a} + ${b} \\times ${c}`,
                        `= ${a} + ${b * c}`,
                        `= ${result}`
                    ]
                };
            }

            generateSequenceDouble() {
                const start = this.randomFloat(1.5, 3.5, 1);
                const seq = [start, start * 2, start * 4, start * 8];
                const nextValue = start * 16;
                return {
                    question: `Compl√®te la suite logique : ${toFrenchNumber(seq[0])} ; ${toFrenchNumber(seq[1])} ; ${toFrenchNumber(seq[2])} ; ? ; ${toFrenchNumber(nextValue)}`,
                    answer: toFrenchNumber(seq[3]),
                    type: 'numerical',
                    explanationSteps: [
                        `\\text{Chaque terme est multipli√© par 2}`,
                        `${toFrenchNumber(seq[0])} \\times 2 = ${toFrenchNumber(seq[1])}`,
                        `${toFrenchNumber(seq[1])} \\times 2 = ${toFrenchNumber(seq[2])}`,
                        `${toFrenchNumber(seq[2])} \\times 2 = ${toFrenchNumber(seq[3])}`
                    ]
                };
            }

            generateBarChart() {
                const categories = ['Chien', 'Chat', 'Autre'];
                const values = [ this.random(150, 250), this.random(200, 350), this.random(100, 200) ];
                const total = values.reduce((a, b) => a + b, 0);
                const barChart = `
                    <div class="bar-chart">
                        <svg width="300" height="200" viewBox="0 0 300 200">
                            ${categories.map((cat, i) => {
                                const barHeight = (values[i] / 400) * 150;
                                const x = 50 + i * 80;
                                return `
                                    <rect x="${x}" y="${170 - barHeight}" width="60" height="${barHeight}" fill="#667eea" opacity="0.8"/>
                                    <text x="${x + 30}" y="190" text-anchor="middle" font-size="12" fill="#333">${cat}</text>
                                    <text x="${x + 30}" y="${165 - barHeight}" text-anchor="middle" font-size="12" fill="#333">${values[i]}</text>
                                `;
                            }).join('')}
                            <line x1="40" y1="170" x2="280" y2="170" stroke="#333" stroke-width="2"/>
                            <line x1="40" y1="20" x2="40" y2="170" stroke="#333" stroke-width="2"/>
                        </svg>
                    </div>`;
                return {
                    question: `Le nombre total d'animaux comptabilis√©s est :`,
                    answer: total.toString(),
                    type: 'numerical',
                    figure: barChart,
                    explanationSteps: [
                        `\\text{Total} = ${values[0]} + ${values[1]} + ${values[2]}`,
                        `= ${total}`
                    ]
                };
            }

            generatePercentageFromFraction() {
                const numerators = [11, 13, 17, 19, 21, 23];
                const denominators = [20, 25, 50];
                const num = numerators[this.random(0, numerators.length - 1)];
                const den = denominators[this.random(0, denominators.length - 1)];
                const percentage = (num / den) * 100;
                return {
                    question: `Sur ${den} chiots, ${num} sont de couleur marron. Quel est le pourcentage de chiots marrons ?`,
                    answer: percentage.toString(),
                    type: 'numerical',
                    unit: '%',
                    explanationSteps: [
                        `\\text{Pourcentage} = \\frac{${num}}{${den}} \\times 100`,
                        `= ${toFrenchNumber(num/den)} \\times 100`,
                        `= ${percentage}\\%`
                    ]
                };
            }

            generateTimeConversion() {
    const hours = this.randomFloat(1, 3, 1);          // ex: 1.3
    const wholeHours = Math.floor(hours);             // ex: 1
    const frac = +(hours - wholeHours).toFixed(2);    // ex: 0.30 (√©crasement artefacts binaires)
    const minutes = Math.round(frac * 60);            // ex: 18

    const answer = `${wholeHours}h${minutes.toString().padStart(2,'0')}min`;

    return {
        question: `Compl√®te : ${toFrenchNumber(hours,1)}h = ...h ...min`,
        answer: answer,
        type: 'time_format',
        explanationSteps: [
            `${toFrenchNumber(hours,1)}\\text{h} = ${wholeHours}\\text{h} + ${toFrenchNumber(frac,1)}\\text{h}`,
            `${toFrenchNumber(frac,1)}\\text{h} = 60\\times${toFrenchNumber(frac,1)}\\text{ min} = ${minutes}\\text{ min}`,
            `\\text{Donc } ${toFrenchNumber(hours,1)}\\text{h} = ${wholeHours}\\text{h}${minutes.toString().padStart(2,'0')}\\text{min}`
        ]
    };
}


            // PATCH: √©viter couples qui donnent des centaines trop faciles (20√ó5, 25√ó4)
            generateProductCalculation() {
                const pool = [2, 3, 4, 5, 6, 8, 9, 12, 15, 20, 25, 50]; // pas de 10
                let a = pool[this.random(0, pool.length - 1)];
                let b = pool[this.random(0, pool.length - 1)];
                let c = this.random(3, 7);
                let d = pool[this.random(0, pool.length - 1)];

                const badPair = (x, y) =>
                    (x === 20 && y === 5) || (x === 5 && y === 20) ||
                    (x === 25 && y === 4) || (x === 4 && y === 25);

                if (badPair(a,b)) b = 6;
                if (badPair(a,d)) d = 6;
                if (badPair(b,d)) d = 6;

                const result = a * b * c * d;
                return {
                    question: `${a} √ó ${b} √ó ${c} √ó ${d}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${a} \\times ${b} \\times ${c} \\times ${d} = ?`,
                    explanationSteps: [
                        `${a} \\times ${b} = ${a * b}`,
                        `${a * b} \\times ${c} = ${a * b * c}`,
                        `${a * b * c} \\times ${d} = ${result}`
                    ]
                };
            }

            generateRectanglePerimeter() {
                const length = this.random(35, 55);
                const width = this.randomFloat(4.5, 8.5, 1);
                const perimeter = 2 * (length/10 + width);
                return {
                    question: `Quel est le p√©rim√®tre d'un rectangle ABCD tel que : AB = ${length} mm et BC = ${toFrenchNumber(width)} cm ?`,
                    answer: toFrenchNumber(perimeter),
                    type: 'numerical',
                    unit: 'cm',
                    explanationSteps: [
                        `AB = ${length}\\text{ mm} = ${toFrenchNumber(length/10)}\\text{ cm}`,
                        `BC = ${toFrenchNumber(width)}\\text{ cm}`,
                        `\\text{P√©rim√®tre} = 2 \\times (AB + BC)`,
                        `= 2 \\times (${toFrenchNumber(length/10)} + ${toFrenchNumber(width)})`,
                        `= 2 \\times ${toFrenchNumber(length/10 + width)}`,
                        `= ${toFrenchNumber(perimeter)}\\text{ cm}`
                    ]
                };
            }

            generateTriangleConstruction() {
                const sides = [
                    [3, 4, 5],
                    [3.5, 5.5, 12],
                    [4, 6, 11],
                    [2.5, 3.5, 7]
                ];
                const [a, b, c] = sides[this.random(0, sides.length - 1)];
                const canConstruct = (a + b > c) && (a + c > b) && (b + c > a);
                return {
                    question: `Peut-on construire un triangle dont les trois c√¥t√©s ont pour longueur : ${toFrenchNumber(a)} cm ; ${toFrenchNumber(b)} cm et ${c} cm ?`,
                    answer: canConstruct ? 'OUI' : 'NON',
                    type: 'yesno',
                    explanationSteps: [
                        `\\text{In√©galit√© triangulaire :}`,
                        `${toFrenchNumber(a)} + ${toFrenchNumber(b)} = ${toFrenchNumber(a + b)} ${a + b > c ? '>' : '‚â§'} ${c}`,
                        `${toFrenchNumber(a)} + ${c} = ${toFrenchNumber(a + c)} ${a + c > b ? '>' : '‚â§'} ${toFrenchNumber(b)}`,
                        `${toFrenchNumber(b)} + ${c} = ${toFrenchNumber(b + c)} ${b + c > a ? '>' : '‚â§'} ${toFrenchNumber(a)}`,
                        canConstruct ? `\\text{Les trois in√©galit√©s sont v√©rifi√©es : OUI}` : `\\text{Au moins une in√©galit√© n'est pas v√©rifi√©e : NON}`
                    ]
                };
            }

            generateVolumePave() {
                const length = this.random(3, 6);
                const width = this.randomFloat(2, 4, 1);
                const height = this.random(2, 4);
                const volume = length * width * height;
                const figure = `
                    <svg width="200" height="150" viewBox="0 0 200 150">
                        <rect x="40" y="50" width="80" height="60" fill="none" stroke="#667eea" stroke-width="2"/>
                        <rect x="80" y="30" width="80" height="60" fill="none" stroke="#667eea" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="40" y1="50" x2="80" y2="30" stroke="#667eea" stroke-width="2"/>
                        <line x1="120" y1="50" x2="160" y2="30" stroke="#667eea" stroke-width="2"/>
                        <line x1="120" y1="110" x2="160" y2="90" stroke="#667eea" stroke-width="2"/>
                        <line x1="40" y1="110" x2="80" y2="90" stroke="#667eea" stroke-width="2" stroke-dasharray="5,5"/>
                        <text x="80" y="130" text-anchor="middle" font-size="12" fill="#333">${length} cm</text>
                        <text x="25" y="85" text-anchor="middle" font-size="12" fill="#333">${toFrenchNumber(width)} cm</text>
                        <text x="145" y="45" text-anchor="middle" font-size="12" fill="#333">${height} cm</text>
                    </svg>`;
                return {
                    question: `Volume de ce pav√© droit :`,
                    answer: toFrenchNumber(volume),
                    type: 'numerical',
                    unit: 'cm¬≥',
                    figure: figure,
                    mathDisplay: `V = ?\\text{ cm}^3`,
                    explanationSteps: [
                        `V = L \\times l \\times h`,
                        `= ${length} \\times ${toFrenchNumber(width)} \\times ${height}`,
                        `= ${toFrenchNumber(volume)}\\text{ cm}^3`
                    ]
                };
            }

            generateLargeNumberMultiplication() {
                const multiples = [11, 12, 13, 14, 15, 16, 17, 18, 19, 21, 101, 111, 201];
                const a = multiples[this.random(0, multiples.length - 1)];
                const b = this.random(2, 9) * 10;
                const result = a * b;
                return {
                    question: `${a} √ó ${b}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${a} \\times ${b} = ?`,
                    explanationSteps: [
                        `${a} \\times ${b} = ${a} \\times ${b/10} \\times 10`,
                        `= ${a * (b/10)} \\times 10`,
                        `= ${result}`
                    ]
                };
            }

            generateEquationSimple() {
                const a = this.random(2, 9);
                return {
                    question: `Calcule n √ó (n + 2) pour n = ${a}`,
                    answer: (a * (a + 2)).toString(),
                    type: 'numerical',
                    mathDisplay: `n \\times (n + 2) \\text{ pour } n = ${a}`,
                    explanationSteps: [
                        `n \\times (n + 2) \\text{ avec } n = ${a}`,
                        `= ${a} \\times (${a} + 2)`,
                        `= ${a} \\times ${a + 2}`,
                        `= ${a * (a + 2)}`
                    ]
                };
            }

            generateFractionThirds() {
                const numerator = this.random(1, 2);
                const whole = this.random(20, 45);
                const result = (numerator * whole) / 3;
                const fractionText = numerator === 1 ? 'tiers' : 'deux tiers';
                if (result === Math.floor(result)) {
                    return {
                        question: `Arthur mange ${numerator === 1 ? 'le' : 'les'} ${fractionText} d'un fromage de ${whole} g. Quelle masse de fromage a-t-il mang√© ?`,
                        answer: result.toString(),
                        type: 'numerical',
                        unit: 'g',
                        explanationSteps: [
                            `\\frac{${numerator}}{3} \\times ${whole}`,
                            `= \\frac{${numerator} \\times ${whole}}{3}`,
                            `= \\frac{${numerator * whole}}{3}`,
                            `= ${result}\\text{ g}`
                        ]
                    };
                } else {
                    return this.generateFractionThirds();
                }
            }

            generateCompleteEquation() {
                const result = this.random(2, 5);
                const multiplier = this.random(2, 4);
                const product = result * multiplier;
                return {
                    question: `Compl√®te : ${multiplier} √ó ... = ${product}`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${multiplier} \\times \\ldots = ${product}`,
                    explanationSteps: [
                        `${multiplier} \\times ? = ${product}`,
                        `? = ${product} \\div ${multiplier}`,
                        `? = ${result}`
                    ]
                };
            }

            generateUnitConversionVolume() {
                const values = [12.5, 22.5, 32.5, 42.5, 52.5];
                const value = values[this.random(0, values.length - 1)];
                const result = value * 1000;
                return {
                    question: `${toFrenchNumber(value)} m¬≥ = ... dm¬≥`,
                    answer: result.toString(),
                    type: 'numerical',
                    mathDisplay: `${toFrenchNumber(value)}\\text{ m}^3 = ?\\text{ dm}^3`,
                    explanationSteps: [
                        `1\\text{ m}^3 = 1000\\text{ dm}^3`,
                        `${toFrenchNumber(value)}\\text{ m}^3 = ${toFrenchNumber(value)} \\times 1000\\text{ dm}^3`,
                        `= ${result}\\text{ dm}^3`
                    ]
                };
            }

         generatePolygonArea() {
    // Donn√©es enti√®res pour des mesures nettes
    const base = this.random(4, 7);    // b (cm)
    const height = this.random(2, 4);  // h (cm)

    const area = base * height + (base * height) / 2; // b*h + (b*h)/2

    // √âchelle (px par cm) + marges g√©n√©reuses
    const scale = 24;
    const W = base * scale;
    const H = height * scale;

    // D√©calages pour que tout rentre largement
    const x0 = 90;          // bas-gauche rectangle (plus de marge √† gauche)
    const y0 = 260;         // baseline plus basse
    const apexY = y0 - 2 * H;

    const widthPx  = Math.max(360, x0 + W + 140); // marge √† droite
    const heightPx = Math.max(320, y0 + 40);      // marge en bas

    // Points du polygone unique (rectangle + triangle isoc√®le)
    const BL = [x0, y0];
    const BR = [x0 + W, y0];
    const TR = [x0 + W, y0 - H];
    const AP = [x0 + W / 2, apexY];
    const TL = [x0, y0 - H];

    const figure = `
        <svg width="${widthPx}" height="${heightPx}" viewBox="0 0 ${widthPx} ${heightPx}">
            <defs>
                <!-- Fl√®ches de cote -->
                <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                    <path d="M 0 0 L 10 5 L 0 10 z" fill="#333"></path>
                </marker>
            </defs>

            <!-- Polygone gris√© -->
            <polygon 
                points="${BL[0]},${BL[1]} ${BR[0]},${BR[1]} ${TR[0]},${TR[1]} ${AP[0]},${AP[1]} ${TL[0]},${TL[1]}"
                fill="rgba(136,136,136,0.3)" stroke="#667eea" stroke-width="2"
            />

            <!-- Altitude du triangle (pointill√©s) + marque d'angle droit -->
            <line x1="${AP[0]}" y1="${AP[1]}" x2="${AP[0]}" y2="${TL[1]}" stroke="#9c27b0" stroke-width="2" stroke-dasharray="6,4"/>
            <path d="M ${AP[0]-10} ${TL[1]} L ${AP[0]-10} ${TL[1]-10} L ${AP[0]} ${TL[1]-10}" fill="none" stroke="#9c27b0" stroke-width="2"/>

            <!-- Cote base b (dessous, avec fl√®ches) -->
            <line x1="${BL[0]}" y1="${BL[1] + 18}" x2="${BR[0]}" y2="${BR[1] + 18}"
                  stroke="#333" stroke-width="1.5" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
            <text x="${(BL[0] + BR[0]) / 2}" y="${BR[1] + 36}" text-anchor="middle" font-size="13" fill="#333">${base} cm (base)</text>

            <!-- Cote h du rectangle (√† GAUCHE, mais √† l'int√©rieur pour ne rien couper) -->
            <line x1="${TL[0] + 14}" y1="${BL[1]}" x2="${TL[0] + 14}" y2="${TL[1]}"
                  stroke="#333" stroke-width="1.5" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
            <text x="${TL[0] + 18}" y="${(BL[1] + TL[1]) / 2}" text-anchor="start" font-size="13" fill="#333">${height} cm (h rect.)</text>

            <!-- Cote h du triangle (√† DROITE, √† l'int√©rieur aussi) -->
            <line x1="${TR[0] - 14}" y1="${TL[1]}" x2="${TR[0] - 14}" y2="${AP[1]}"
                  stroke="#333" stroke-width="1.5" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
            <text x="${TR[0] - 18}" y="${(TL[1] + AP[1]) / 2}" text-anchor="end" font-size="13" fill="#333">${height} cm (h tri.)</text>
        </svg>
    `;

    return {
        question: `Aire du polygone gris√© :`,
        answer: area.toString(),
        type: 'numerical',
        unit: 'cm¬≤',
        figure,
        mathDisplay: `A = b\\times h + \\dfrac{b\\times h}{2}`,
        explanationSteps: [
            `\\text{Rectangle : } ${base} \\times ${height} = ${base * height}\\text{ cm}^2`,
            `\\text{Triangle : } \\dfrac{${base} \\times ${height}}{2} = ${(base * height)/2}\\text{ cm}^2`,
            `\\text{Total : } ${base * height} + ${(base * height)/2} = ${area}\\text{ cm}^2`
        ]
    };
}


            // PATCH: √©viter a,b cons√©cutifs (diff=1) ou trop proches (diff=2)
            generateProductSumDifference() {
                let a, b, diff;
                do {
                    a = this.random(8, 20);
                    b = this.random(8, 20);
                    diff = Math.abs(a - b);
                } while (a === b || diff < 3 || diff > 9);

                const sum = a + b;
                const product = sum * diff;

                return {
                    question: `Le produit de la somme de ${a} et ${b} par la diff√©rence de ${Math.max(a,b)} et ${Math.min(a,b)} est √©gal √† :`,
                    answer: product.toString(),
                    type: 'numerical',
                    explanationSteps: [
                        `\\text{Somme : } ${a} + ${b} = ${sum}`,
                        `\\text{Diff√©rence : } ${Math.max(a,b)} - ${Math.min(a,b)} = ${diff}`,
                        `\\text{Produit : } ${sum} \\times ${diff} = ${product}`
                    ]
                };
            }
        

            generatePowerOfSix() {
    // On choisit un chiffre d entre 3 et 9 pour varier l'expression
    const d = this.random(3, 9);
    const result = d - (d / d) * d + d * d; // = d - 1*d + d^2 = d^2

    return {
        question: `${d} - ${d} √∑ ${d} √ó ${d} + ${d} √ó ${d}`,
        answer: result.toString(),
        type: 'numerical',
        mathDisplay: `${d} - ${d} \\div ${d} \\times ${d} + ${d} \\times ${d} = ?`,
        explanationSteps: [
            `\\text{Priorit√© : divisions et multiplications de gauche √† droite}`,
            `${d} - (${d} \\div ${d}) \\times ${d} + ${d} \\times ${d}`,
            `= ${d} - 1 \\times ${d} + ${d} \\times ${d}`,
            `= ${d} - ${d} + ${d}\\,^2`,
            `= ${d}\\,^2 = ${result}`
        ]
    };
}
}

        // ===== Flux principal =====
        function startQuiz() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const mode = document.getElementById('mode').value;

            currentQuestionIndex = 0;
            questions = [];
            userAnswers = [];
            hasAnswered = false;
            questionTimes = [];

            if (mode === 'exam') { examTimeRemaining = 540; startExamTimer(); }

            const generator = new QuestionGenerator();
const seen = new Set();
for (let i = 0; i < questionCount; i++) 
{
    let q, tries = 0;
    do {
        q = generator.generateQuestion();
        tries++;
        // cl√© bas√©e sur l'√©nonc√© (question + mathDisplay si pr√©sent)
        const key = q.question + '|' + (q.mathDisplay || '') + '|' + (q.figure ? '[fig]' : '');
        if (!seen.has(key)) 
        {
            seen.add(key);
            questions.push(q);
            break;
        }
        } while (tries < 20);

    // En dernier recours, si on n'a rien pu ajouter (extr√™mement rare), on pousse la derni√®re version
    if (tries >= 20 && questions.length < i + 1) 
    {
        questions.push(q);
    }
}
 showQuestion();
}

        function startExamTimer() {
            clearInterval(examTimer);
            examTimer = setInterval(() => {
                examTimeRemaining--;
                updateExamTimerDisplay();
                if (examTimeRemaining <= 0) {
                    clearInterval(examTimer);
                    for (let i = currentQuestionIndex; i < questions.length; i++) {
                        userAnswers.push({
                            question: questions[i].question,
                            userAnswer: '',
                            correctAnswer: questions[i].answer,
                            isCorrect: false,
                            timeSpent: 0,
                            explanationSteps: questions[i].explanationSteps,
                            mathDisplay: questions[i].mathDisplay,
                            figure: questions[i].figure
                        });
                    }
                    showResults();
                }
            }, 1000);
        }

        function updateExamTimerDisplay() {
            const mode = document.getElementById('mode').value;
            if (mode === 'exam') {
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    const mins = Math.floor(examTimeRemaining / 60);
                    const secs = examTimeRemaining % 60;
                    timerElement.textContent = `‚è±Ô∏è ${mins}:${secs.toString().padStart(2, '0')}`;
                    if (examTimeRemaining < 60) {
                        timerElement.style.color = '#dc3545';
                        timerElement.style.fontWeight = 'bold';
                    }
                }
            }
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) { clearInterval(examTimer); showResults(); return; }

            hasAnswered = false;
            questionStartTime = Date.now();
            const question = questions[currentQuestionIndex];
            const quizContainer = document.getElementById('quizContainer');
            const mode = document.getElementById('mode').value;

            let questionHTML = `
                <div class="question-header">
                    <div class="question-number">Question ${currentQuestionIndex + 1} / ${questions.length}</div>
                    <div class="timer" id="timer">‚è±Ô∏è ${mode === 'exam' ? Math.floor(examTimeRemaining / 60) + ':' + (examTimeRemaining % 60).toString().padStart(2, '0') : '0s'}</div>
                </div>
            `;
            if (mode === 'exam') {
                questionHTML += `<div class="mode-info">‚ö†Ô∏è Mode Examen : 9 minutes pour ${questions.length} questions - Pas d'explications</div>`;
            }

            questionHTML += `<div class="question-content"><div class="question-text">${question.question}</div>`;
            if (question.mathDisplay) questionHTML += `<div class="math-display">${renderMathDisplay(question.mathDisplay)}</div>`;
            if (question.figure) questionHTML += `<div class="figure-container">${question.figure}</div>`;

            let placeholderText = 'Votre r√©ponse';
            if (question.unit) placeholderText += ` (en ${question.unit})`;
            else if (question.type === 'yesno') placeholderText = 'OUI ou NON';
            else if (question.type === 'time') placeholderText = 'Format: 16h30';
            else if (question.type === 'fraction') placeholderText = 'Format: 3/4';

            questionHTML += `
                    <input type="text" class="answer-input" id="answerInput" placeholder="${placeholderText}" onkeypress="if(event.key === 'Enter') validateAnswer()">
                </div>
                <div class="question-actions" id="questionActions">
                    <button class="btn-validate" onclick="validateAnswer()">‚úì Valider</button>
                    <button class="btn-skip" onclick="skipQuestion()">‚Üí Passer</button>
                </div>
                <div id="feedback"></div>
            `;

            quizContainer.innerHTML = questionHTML;
            document.getElementById('answerInput').focus();

            if (mode === 'training') startTimer(); else updateExamTimerDisplay();
        }

        function startTimer() {
            clearInterval(timer);
            timeElapsed = 0;
            timer = setInterval(() => {
                timeElapsed++;
                const mode = document.getElementById('mode').value;
                const timerElement = document.getElementById('timer');
                if (timerElement && !hasAnswered && mode === 'training') timerElement.textContent = `‚è±Ô∏è ${timeElapsed}s`;
            }, 1000);
        }

        function validateAnswer() {
            if (hasAnswered) return;
            const mode = document.getElementById('mode').value;
            if (mode === 'training') clearInterval(timer);
            hasAnswered = true;

            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);
            questionTimes.push(timeSpent);

            const userAnswer = document.getElementById('answerInput').value.trim();
            const currentQuestion = questions[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer;

            // Normalisation & comparaison
            let normalizedUserAnswer = normalizeNumberLike(userAnswer);
            let normalizedCorrectAnswer = normalizeNumberLike(correctAnswer);

            if (currentQuestion.type === 'yesno') {
                normalizedUserAnswer = normalizedUserAnswer.toUpperCase();
                normalizedCorrectAnswer = normalizedCorrectAnswer.toUpperCase();
            }

            if (currentQuestion.type === 'time' || currentQuestion.type === 'time_format') {
                const fix = s => s
                    .replace(/(\d+)h(\d)(?!\d)/, (_, H, m) => `${H}h0${m}`)
                    .replace(/^(\d+)h$/, '$1h00');
                normalizedUserAnswer = fix(normalizedUserAnswer);
                normalizedCorrectAnswer = fix(normalizedCorrectAnswer);
            }

            let isCorrect;
            if (currentQuestion.type === 'numerical' || currentQuestion.type === 'time_format') {
                isCorrect = isNumericEquivalent(normalizedUserAnswer, normalizedCorrectAnswer);
            } else {
                isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
            }

            userAnswers.push({
                question: currentQuestion.question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timeSpent: timeSpent,
                explanationSteps: currentQuestion.explanationSteps,
                mathDisplay: currentQuestion.mathDisplay,
                figure: currentQuestion.figure,
                unit: currentQuestion.unit
            });

            if (mode === 'training') {
                const feedback = document.getElementById('feedback');
                feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
                let feedbackHTML = isCorrect
                    ? `‚úì Correct ! Bien jou√© ! (Temps: ${timeSpent}s)`
                    : `‚úó Incorrect. La bonne r√©ponse √©tait : ${correctAnswer}${currentQuestion.unit ? ' ' + currentQuestion.unit : ''} (Temps: ${timeSpent}s)`;

                if (currentQuestion.explanationSteps) {
                    feedbackHTML += `
                        <div class="explanation-box ${isCorrect ? 'correct' : 'incorrect'}">
                            <strong>üìù Explication :</strong>
                            ${renderExplanation(currentQuestion.explanationSteps)}
                        </div>`;
                }
                feedback.innerHTML = feedbackHTML;

                const actionsDiv = document.getElementById('questionActions');
                actionsDiv.innerHTML = '<button class="btn-next" onclick="nextQuestion()">Suivant ‚Üí</button>';
                document.getElementById('answerInput').disabled = true;
            } else {
                nextQuestion();
            }
        }

        function skipQuestion() {
            if (hasAnswered) return;
            const mode = document.getElementById('mode').value;
            if (mode === 'training') clearInterval(timer);
            hasAnswered = true;

            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);
            questionTimes.push(timeSpent);

            const currentQuestion = questions[currentQuestionIndex];
            userAnswers.push({
                question: currentQuestion.question,
                userAnswer: '',
                correctAnswer: currentQuestion.answer,
                isCorrect: false,
                timeSpent: timeSpent,
                explanationSteps: currentQuestion.explanationSteps,
                mathDisplay: currentQuestion.mathDisplay,
                figure: currentQuestion.figure,
                unit: currentQuestion.unit
            });

            if (mode === 'training') {
                const feedback = document.getElementById('feedback');
                feedback.className = 'feedback incorrect';
                let feedbackHTML = `‚úó Question pass√©e. La bonne r√©ponse √©tait : ${currentQuestion.answer}${currentQuestion.unit ? ' ' + currentQuestion.unit : ''} (Temps: ${timeSpent}s)`;
                if (currentQuestion.explanationSteps) {
                    feedbackHTML += `
                        <div class="explanation-box incorrect">
                            <strong>üìù Explication :</strong>
                            ${renderExplanation(currentQuestion.explanationSteps)}
                        </div>`;
                }
                feedback.innerHTML = feedbackHTML;
                const actionsDiv = document.getElementById('questionActions');
                actionsDiv.innerHTML = '<button class="btn-next" onclick="nextQuestion()">Suivant ‚Üí</button>';
                document.getElementById('answerInput').disabled = true;
            } else {
                nextQuestion();
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showResults() {
            clearInterval(timer);
            clearInterval(examTimer);

            const correctCount = userAnswers.filter(a => a.isCorrect).length;
            const percentage = Math.round((correctCount / questions.length) * 100);
            const totalTime = questionTimes.reduce((a, b) => a + b, 0);
            const avgTime = questions.length > 0 ? Math.round(totalTime / questions.length) : 0;
            const mode = document.getElementById('mode').value;

            const quizContainer = document.getElementById('quizContainer');

            let reviewHTML = '';
            userAnswers.forEach((answer, index) => {
                let questionReview = `
                    <div class="question-review ${answer.isCorrect ? 'correct' : 'incorrect'}">
                        <strong>Q${index + 1}:</strong> ${answer.question}<br>
                `;
                if (answer.figure) questionReview += `<div class="figure-container">${answer.figure}</div>`;
                questionReview += `
                        <strong>Votre r√©ponse:</strong> ${answer.userAnswer || 'Pas de r√©ponse'}<br>
                        <strong>R√©ponse correcte:</strong> ${answer.correctAnswer}${answer.unit ? ' ' + answer.unit : ''}<br>
                `;
                if (mode === 'training') questionReview += `<div class="time-info">‚è±Ô∏è Temps: ${answer.timeSpent}s</div>`;
                if (answer.explanationSteps) {
                    questionReview += `
                        <div class="review-explanation">
                            <strong>üìù Explication :</strong>
                            ${renderExplanation(answer.explanationSteps)}
                        </div>
                    `;
                }
                questionReview += `</div>`;
                reviewHTML += questionReview;
            });

            let statsHTML = '';
            if (mode === 'training') {
                statsHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="color: #1976d2; margin-bottom: 10px;">üìä Statistiques de temps</h3>
                        <p style="font-size: 1.1em; color: #333;">
                            Temps total : ${formatTime(totalTime)}<br>
                            Temps moyen par question : ${avgTime}s<br>
                            ${questionTimes.length > 0 ? `Question la plus rapide : ${Math.min(...questionTimes)}s<br>` : ''}
                            ${questionTimes.length > 0 ? `Question la plus longue : ${Math.max(...questionTimes)}s` : ''}
                        </p>
                    </div>
                `;
            } else {
                const timeUsed = 540 - examTimeRemaining;
                statsHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="color: #856404; margin-bottom: 10px;">‚è±Ô∏è Mode Examen</h3>
                        <p style="font-size: 1.1em; color: #333;">
                            Temps utilis√© : ${formatTime(timeUsed)} sur 9 minutes<br>
                            ${timeUsed > 540 ? '<span style="color: red;">Temps d√©pass√© !</span>' : 'Test compl√©t√© dans le temps imparti'}
                        </p>
                    </div>
                `;
            }

            quizContainer.innerHTML = `
                <div class="results">
                    <h2>üéØ R√©sultats du test</h2>
                    <div class="score">${correctCount} / ${questions.length}</div>
                    <p style="font-size: 1.2em; color: #666;">Score: ${percentage}%</p>
                    ${statsHTML}
                    <div class="results-details">
                        <h3>üìä D√©tail des r√©ponses${mode === 'training' ? ' avec explications' : ''}</h3>
                        ${reviewHTML}
                    </div>
                    <button onclick="location.reload()">üîÑ Nouveau test</button>
                </div>
            `;
        }

        // ===== Initialisation =====
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof renderMathInElement !== 'undefined') {
    renderMathInElement(document.body, {
        delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$",  right: "$",  display: false }
        ]
    });
}
});
window.startQuiz = startQuiz;
  window.validateAnswer = validateAnswer;
  window.skipQuestion = skipQuestion;
  window.nextQuestion = nextQuestion;
    </script>
</body>
</html>
